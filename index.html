<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8N Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{margin:0;padding:0;font-family:system-ui,-apple-system,sans-serif;overflow:hidden}
        @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes float{from{transform:translate(-50px,-50px)}to{transform:translate(0,0)}}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
        .message-enter{animation:slideIn .3s ease-out}
        .spinner{border:2px solid #f3f3f3;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite}
        #messageInput{min-height:48px;max-height:150px}
        .nav-item{transition:all .2s}
        .nav-item:hover{background-color:rgba(59,130,246,.1)}
        .nav-item.active{background-color:rgba(59,130,246,.2);border-left:3px solid #3b82f6}
        #chatView,#messagesArea{display:flex;flex-direction:column;height:100%}
        #messagesArea{flex:1;overflow-y:auto;overflow-x:hidden}
        .editable-cell{cursor:pointer;position:relative;transition:background-color .2s}
        .editable-cell:hover{background-color:rgba(59,130,246,.1)}
        .text-editable-cell{cursor:text;position:relative;transition:background-color .2s;min-width:150px}
        .text-editable-cell:hover{background-color:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3)}
        .text-editable-cell input{width:100%;background:0 0;border:none;color:#fff;padding:0;outline:0}
        .text-editable-cell input:focus{background:rgba(15,23,42,.8);padding:.25rem;border-radius:.25rem}
        .truncated-cell{max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:help;position:relative}
        .truncated-cell:hover::after{content:attr(data-full-text);position:absolute;left:0;top:100%;background:#1e293b;border:1px solid #475569;padding:.5rem;border-radius:.5rem;z-index:1000;white-space:normal;max-width:300px;box-shadow:0 10px 25px rgba(0,0,0,.5);margin-top:.25rem}
        .saved-indicator,.saving-indicator{position:absolute;top:2px;right:2px;width:8px;height:8px;border-radius:50%}
        .saving-indicator{background:#f59e0b;animation:pulse 1s infinite}
        .saved-indicator{background:#10b981}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .2s ease-out}
        .modal-content{background:#1e293b;border:1px solid #475569;border-radius:1rem;padding:2rem;max-width:500px;width:90%;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);animation:slideUp .3s ease-out}
        .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);position:relative;overflow:hidden}
        .login-container::before{content:'';position:absolute;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 1px,transparent 1px);background-size:50px 50px;animation:float 20s linear infinite}
        .login-box{background:rgba(30,41,59,.95);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:1.5rem;padding:3rem;width:100%;max-width:420px;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);animation:slideUp .5s ease-out;position:relative;z-index:1}
        .input-group{position:relative;margin-bottom:1.5rem}
        .input-group input{width:100%;padding:.875rem 1rem .875rem 3rem;background:rgba(15,23,42,.6);border:2px solid rgba(148,163,184,.2);border-radius:.75rem;color:#fff;font-size:.95rem;transition:all .3s}
        .input-group input:focus{outline:0;border-color:#3b82f6;background:rgba(15,23,42,.8)}
        .input-group svg{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:#94a3b8;pointer-events:none}
        .login-button{width:100%;padding:.875rem;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);border:none;border-radius:.75rem;color:#fff;font-weight:600;font-size:1rem;cursor:pointer;transition:all .3s;box-shadow:0 4px 15px rgba(102,126,234,.4)}
        .login-button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.6)}
        .login-button:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .error-message{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5;padding:.75rem 1rem;border-radius:.5rem;margin-bottom:1rem;font-size:.875rem;animation:shake .5s}
        .btn-custom-blue{background-color:rgb(72,89,169)}
        .btn-custom-blue:hover{background-color:rgb(62,79,159)}
        .status-option-btn{width:100%;padding:1rem;font-size:1.1rem;font-weight:600;border-radius:.75rem;transition:all .3s;border:2px solid transparent}
        .status-option-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
        .status-annullare{background:linear-gradient(135deg,#ef4444 0,#dc2626 100%);color:#fff}
        .status-annullare:hover{border-color:#fca5a5}
        .status-rispedire{background:linear-gradient(135deg,#10b981 0,#059669 100%);color:#fff}
        .status-rispedire:hover{border-color:#86efac}
        .status-attesa{background:linear-gradient(135deg,#f59e0b 0,#d97706 100%);color:#fff}
        .status-attesa:hover{border-color:#fcd34d}
        .delete-row-btn{padding:.5rem;background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.3);border-radius:.5rem;color:#ef4444;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .delete-row-btn:hover{background:rgba(239,68,68,.3);border-color:rgba(239,68,68,.5);transform:scale(1.1)}
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Benvenuto</h1>
                <p class="text-slate-400">Accedi per continuare</p>
            </div>
            <div id="loginError" class="error-message hidden"><span id="loginErrorText"></span></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <input type="text" id="username" placeholder="Nome utente" required autocomplete="username"/>
                </div>
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <input type="password" id="password" placeholder="Password" required autocomplete="current-password"/>
                </div>
                <button type="submit" id="loginButton" class="login-button">
                    <span id="loginButtonText">Accedi</span>
                    <div id="loginSpinner" class="spinner hidden mx-auto"></div>
                </button>
            </form>
        </div>
    </div>
    <div id="mainApp" class="hidden">
        <div class="flex h-screen">
            <div class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col">
                <div class="p-4 border-b border-slate-700">
                    <h1 class="text-xl font-bold text-white">üîó N8N Interface</h1>
                    <p class="text-xs text-slate-400 mt-1">Utente: <span id="currentUsername" class="text-blue-400"></span></p>
                </div>
                <nav class="flex-1 p-2">
                    <button onclick="switchView('chat')" id="navChat" class="nav-item active w-full text-left px-4 py-3 rounded-lg text-white flex items-center gap-3 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <span class="font-medium">Chat</span>
                    </button>
                    <button onclick="switchView('table')" id="navTable" class="nav-item w-full text-left px-4 py-3 rounded-lg text-white flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                        <span class="font-medium">Tabella</span>
                    </button>
                </nav>
                <div class="p-4 border-t border-slate-700 space-y-2">
                    <button id="settingsBtn" onclick="toggleSettings()" class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors hidden">‚öôÔ∏è Impostazioni</button>
                    <button id="clearChatBtn" onclick="clearChatHistory()" class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors">üóëÔ∏è Cancella Chat</button>
                    <button onclick="handleLogout()" class="w-full px-4 py-2 btn-custom-blue text-white rounded-lg text-sm transition-colors">üö™ Logout</button>
                </div>
            </div>
            <div class="flex-1 flex flex-col relative">
                <div id="settingsPanel" class="hidden bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 p-4 absolute top-0 left-0 right-0 z-10">
                    <h2 class="text-white font-bold mb-3">Configurazione API</h2>
                    <div class="space-y-3">
                        <div><label class="text-sm text-slate-300 block mb-1">API Login:</label><input type="text" id="loginApiUrl" value="https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/sing-up" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none text-sm"/></div>
                        <div><label class="text-sm text-slate-300 block mb-1">Webhook Chat:</label><input type="text" id="webhookUrl" value="https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/chat" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none text-sm"/></div>
                        <div><label class="text-sm text-slate-300 block mb-1">API Tabella:</label><input type="text" id="tableApiUrl" value="https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/data" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none text-sm"/></div>
                        <div><label class="text-sm text-slate-300 block mb-1">API Elimina Tabella:</label><input type="text" id="deleteApiUrl" value="https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/deletetab" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none text-sm"/></div>
                        <div><label class="text-sm text-slate-300 block mb-1">API Modifica Cella:</label><input type="text" id="updateApiUrl" value="https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/edit-tab" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none text-sm"/></div>
                        <div><label class="text-sm text-slate-300 block mb-1">API Elimina Riga:</label><input type="text" id="deleteRowApiUrl" value="https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/delete-one-row" class="w-full px-3 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none text-sm"/></div>
                    </div>
                </div>
                <div id="chatView" class="absolute inset-0 flex flex-col bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                    <div class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 p-4 flex-shrink-0"><h2 class="text-xl font-bold text-white">üí¨ Chat</h2></div>
                    <div id="messagesArea" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div id="welcomeMessage" class="text-center text-slate-400 mt-20"><p class="text-lg mb-2">üëã Benvenuto!</p><p class="text-sm">Invia un messaggio per iniziare a comunicare con n8n</p></div>
                    </div>
                    <div class="bg-slate-800/50 backdrop-blur-sm border-t border-slate-700 p-4 flex-shrink-0">
                        <div class="flex gap-2 max-w-4xl mx-auto">
                            <textarea id="messageInput" placeholder="Scrivi un messaggio..." class="flex-1 px-4 py-3 bg-slate-700 text-white rounded-xl border border-slate-600 focus:border-blue-500 focus:outline-none resize-none" rows="1"></textarea>
                            <button id="sendButton" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-xl transition-colors flex items-center gap-2 shadow-lg">
                                <svg id="sendIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                <div id="loadingIcon" class="spinner hidden"></div>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="tableView" class="hidden absolute inset-0 flex flex-col bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
                    <div class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 p-4 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-white">üìä Dati Tabella <span class="text-sm text-slate-400">(clicca per modificare)</span></h2>
                        <div class="flex gap-2">
                            <button onclick="loadTableData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Ricarica</button>
                            <button onclick="exportToCSV()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Esporta CSV</button>
                            <button onclick="deleteTable()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Elimina Tabella</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto p-4">
                        <div id="tableLoading" class="hidden flex items-center justify-center h-full"><div class="text-center"><div class="spinner mx-auto mb-4" style="width:40px;height:40px;border-width:4px"></div><p class="text-slate-400">Caricamento dati...</p></div></div>
                        <div id="tableError" class="hidden bg-red-600/20 border border-red-500/30 rounded-lg p-4 text-red-200 mb-4"><p class="font-bold mb-2">‚ùå Errore</p><p id="tableErrorMessage" class="whitespace-pre-wrap"></p></div>
                        <div id="tableContent" class="bg-slate-800 rounded-lg shadow-xl overflow-hidden">
                            <div class="overflow-x-auto"><table class="w-full"><thead id="tableHead" class="bg-slate-700"></thead><tbody id="tableBody" class="divide-y divide-slate-700"></tbody></table></div>
                            <div id="emptyState" class="text-center py-12 text-slate-400"><p class="text-lg mb-2">üì≠ Nessun dato disponibile</p><p class="text-sm">Clicca "Ricarica" per caricare i dati</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="statusModal" class="modal-overlay hidden"><div class="modal-content"><div class="mb-6"><h3 class="text-2xl font-bold text-white mb-3 text-center">üîÑ Seleziona Nuovo Stato</h3><p class="text-slate-300 text-center text-sm">Scegli lo stato da applicare</p></div><div class="space-y-3"><button onclick="selectStatus('Annullare')" class="status-option-btn status-annullare">‚ùå Annullare</button><button onclick="selectStatus('Rispedire')" class="status-option-btn status-rispedire">‚úÖ Rispedire</button><button onclick="selectStatus('Attesa')" class="status-option-btn status-attesa">‚è≥ Attesa</button></div><div class="mt-6 flex justify-center"><button onclick="closeStatusModal()" class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors font-medium">Annulla</button></div></div></div>
    <div id="confirmModal" class="modal-overlay hidden"><div class="modal-content"><div class="flex items-start gap-4 mb-6"><div class="flex-shrink-0 w-12 h-12 bg-red-600/20 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-500"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div><div class="flex-1"><h3 class="text-xl font-bold text-white mb-2">‚ö†Ô∏è Conferma Eliminazione</h3><p class="text-slate-300 leading-relaxed">Sei sicuro di voler eliminare <strong>TUTTI i dati</strong> della tabella?</p><p class="text-red-400 text-sm mt-3 font-semibold">‚ö° Questa operazione √® IRREVERSIBILE!</p></div></div><div class="flex gap-3 justify-end"><button onclick="closeConfirmModal()" class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors font-medium">Annulla</button><button onclick="confirmDelete()" class="px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-medium flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Elimina Tutto</button></div></div></div>
    <div id="deleteRowModal" class="modal-overlay hidden"><div class="modal-content"><div class="flex items-start gap-4 mb-6"><div class="flex-shrink-0 w-12 h-12 bg-red-600/20 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-500"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></div><div class="flex-1"><h3 class="text-xl font-bold text-white mb-2">üóëÔ∏è Conferma Eliminazione Riga</h3><p class="text-slate-300 leading-relaxed">Sei sicuro di voler eliminare <strong>questa riga</strong>?</p><p class="text-red-400 text-sm mt-3 font-semibold">‚ö†Ô∏è Questa operazione √® irreversibile!</p></div></div><div class="flex gap-3 justify-end"><button onclick="closeDeleteRowModal()" class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors font-medium">Annulla</button><button onclick="confirmDeleteRow()" class="px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-medium flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Elimina Riga</button></div></div></div>
    <div id="logoutModal" class="modal-overlay hidden"><div class="modal-content"><div class="flex items-start gap-4 mb-6"><div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background-color:rgba(72,89,169,.2)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" view
