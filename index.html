<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casahoro Viewer</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { margin:0; padding:0; font-family: system-ui; overflow:hidden; }
        .message-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .spinner { border:2px solid #f3f3f3; border-top:2px solid #3b82f6; border-radius:50%; width:16px; height:16px; animation:spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    </style>
</head>

<body class="bg-slate-900">

<!-- ======================= LOGIN SCREEN ======================= -->
<div id="loginScreen" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800">
    <div class="bg-slate-800/80 backdrop-blur-xl p-10 rounded-2xl w-[380px] shadow-xl">
        <h2 class="text-3xl text-white font-bold text-center mb-6">Benvenuto</h2>

        <div id="loginError" class="hidden text-red-400 text-center mb-4"></div>

        <form id="loginForm" onsubmit="handleLogin(event)">
            <input id="username" type="text" placeholder="Email" required class="w-full mb-3 px-4 py-3 bg-slate-700 text-white rounded-lg">
            <input id="password" type="password" placeholder="Password" required class="w-full mb-4 px-4 py-3 bg-slate-700 text-white rounded-lg">
            <button id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg">
                Accedi
            </button>
        </form>
    </div>
</div>

<!-- ======================= MAIN APP ======================= -->
<div id="mainApp" class="hidden h-screen flex">

    <!-- ======================= SIDEBAR ======================= -->
    <div class="w-64 bg-slate-800 border-r border-slate-700 p-4 flex flex-col">

        <h1 class="text-xl text-white font-bold mb-4">Casahoro Viewer</h1>

        <nav class="space-y-2">

            <!-- CHAT LELLA -->
            <button onclick="switchChat('lella')" id="nav-lella"
                class="w-full px-4 py-3 rounded-lg bg-slate-700 text-left text-white">
                ðŸ’¬ Chat - Lella
            </button>

            <!-- CHAT EVASORE -->
            <button onclick="switchChat('evasore')" id="nav-evasore"
                class="w-full px-4 py-3 rounded-lg text-left text-white hover:bg-slate-700">
                ðŸšš Evasore Ordini
            </button>

            <!-- CHAT GOD OF RETURNS -->
            <button onclick="switchChat('god')" id="nav-god"
                class="w-full px-4 py-3 rounded-lg text-left text-white hover:bg-slate-700">
                ðŸ”¥ God of Returns
            </button>

            <!-- TAB LELLA -->
            <button onclick="switchView('table')" id="navTable"
                class="w-full px-4 py-3 mt-4 rounded-lg text-left text-white hover:bg-slate-700">
                ðŸ“Š Tabella - Lella
            </button>
        </nav>

        <button onclick="logout()" class="mt-auto w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg">
            Logout
        </button>
    </div>

    <!-- ======================= CHAT AREA ======================= -->
    <div class="flex-1 flex flex-col" id="chatView">

        <div class="bg-slate-800 p-4 border-b border-slate-700">
            <h2 id="chatTitle" class="text-xl text-white font-bold">Chat - Lella</h2>
        </div>

        <div id="messagesArea" class="flex-1 p-6 overflow-y-auto space-y-4"></div>

        <div class="bg-slate-800 p-4 border-t border-slate-700">
            <div class="flex gap-2">
                <textarea id="messageInput"
                    class="flex-1 bg-slate-700 text-white px-4 py-3 rounded-lg resize-none"
                    placeholder="Scrivi un messaggio..." rows="1"></textarea>

                <button id="sendButton" onclick="sendMessage()"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                    Invia
                </button>
            </div>
        </div>
    </div>

    <!-- ======================= TABLE VIEW ======================= -->
    <div id="tableView" class="hidden flex-1 flex flex-col">
        <div class="bg-slate-800 p-4 border-b border-slate-700">
            <h2 class="text-white text-xl font-bold">Tabella - Lella</h2>
        </div>

        <div class="p-4 text-white">
            ðŸ”§ <i>Qui puoi inserire la tua tabella originale.</i>
        </div>
    </div>

</div>


<!-- ======================= JAVASCRIPT ======================= -->
<script>

    /* ===========================
       CONFIG PER LE 3 CHAT
    ============================ */

    const chatConfig = {
        lella: {
            title: "Chat - Lella",
            webhook: "https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/chat",
            storageKey: "chat_history_lella"
        },
        evasore: {
            title: "Evasore Ordini",
            webhook: "https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/evasore-ordini",
            storageKey: "chat_history_evasore"
        },
        god: {
            title: "God of Returns",
            webhook: "https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/god-of-returns",
            storageKey: "chat_history_god"
        }
    };

    let currentChat = "lella";

    /* ===========================
       LOGIN
    ============================ */

    function handleLogin(e){
        e.preventDefault();

        const u = username.value;
        const p = password.value;

        if(u && p){
            loginScreen.classList.add("hidden");
            mainApp.classList.remove("hidden");
            loadChatHistory();
        } else {
            loginError.textContent = "Credenziali non valide.";
            loginError.classList.remove("hidden");
        }
    }

    function logout(){
        location.reload();
    }

    /* ===========================
       SWITCH CHAT
    ============================ */

    function switchChat(chatId){
        currentChat = chatId;

        document.getElementById("chatTitle").textContent = chatConfig[chatId].title;

        document.querySelectorAll("nav button").forEach(b => b.classList.remove("bg-slate-700"));
        document.getElementById("nav-" + chatId).classList.add("bg-slate-700");

        messagesArea.innerHTML = "";
        loadChatHistory();

        chatView.classList.remove("hidden");
        tableView.classList.add("hidden");
    }

    /* ===========================
       SWITCH TABLE
    ============================ */

    function switchView(view){
        if(view === "table"){
            chatView.classList.add("hidden");
            tableView.classList.remove("hidden");
        }
    }

    /* ===========================
       MESSAGGI
    ============================ */

    function addMessage(text, sender){
        const div = document.createElement("div");
        div.className = `flex ${sender === "user" ? "justify-end" : "justify-start"} message-enter`;

        div.innerHTML = `
            <div class="px-4 py-3 rounded-xl shadow bg-${sender === "user" ? "blue-600 text-white" : "slate-700 text-white"} max-w-[70%]">
                ${text}
            </div>
        `;

        messagesArea.appendChild(div);
        messagesArea.scrollTop = messagesArea.scrollHeight;
        saveChatHistory();
    }

    async function sendMessage(){
        const text = messageInput.value.trim();
        if(!text) return;

        addMessage(text, "user");
        messageInput.value = "";

        try {
            const res = await fetch(chatConfig[currentChat].webhook, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message: text })
            });

            const data = await res.json();
            addMessage(data.response || "OK", "bot");

        } catch (e){
            addMessage("âŒ Errore di connessione", "bot");
        }
    }

    /* ===========================
       LOCAL STORAGE
    ============================ */

    function saveChatHistory(){
        const msgs = [];
        messagesArea.querySelectorAll(".flex").forEach(m => msgs.push(m.innerText));
        localStorage.setItem(chatConfig[currentChat].storageKey, JSON.stringify(msgs));
    }

    function loadChatHistory(){
        const saved = localStorage.getItem(chatConfig[currentChat].storageKey);
        if(!saved) return;

        const msgs = JSON.parse(saved);
        msgs.forEach(m => addMessage(m, "bot"));
    }

</script>

</body>
</html>
