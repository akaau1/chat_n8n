<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FenixHome Chat-bot</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stili Base */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden;
            /* NUOVO TEMA SCURO: Sfondo pi√π profondo */
            background-color: #0A0A1A; /* Un blu scuro molto profondo */
            color: #E0E0F0; /* Testo chiaro */
        }
        /* Animazioni e Transizioni */
        .message-enter {
            /* Animazione pi√π fluida e moderna */
            animation: fadeInSlideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spinner {
            /* Colore spinner aggiornato al nuovo colore primario */
            border: 2px solid #6366F1; /* indigo-500 */
            border-top: 2px solid #1F2937; /* slate-800 */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-item {
            transition: all 0.3s ease-in-out; /* Transizione pi√π lunga */
            border-radius: 0.75rem;
            transform: scale(1);
            position: relative; /* Per l'effetto hover */
            overflow: hidden;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #6366F1; /* Colore primario */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 0;
        }
        .nav-item:hover::before {
            opacity: 0.1;
        }
        .nav-item.active {
            background-color: rgba(99, 102, 241, 0.2); /* indigo-500 con opacit√† */
            border-left: 3px solid #6366F1; /* indigo-500 */
        }
        .nav-item.active:hover::before {
            opacity: 0; /* Disabilita l'effetto ::before sull'attivo per evitare sovrapposizioni */
        }
        /* Stili Chat */
        #messageInput {
            min-height: 48px;
            max-height: 150px;
            transition: all 0.2s;
            background-color: #1F2937; /* Sfondo input pi√π scuro */
            border: 1px solid #374151;
            color: #E0E0F0;
            border-radius: 12px;
        }
        #messageInput:focus {
            border-color: #6366F1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        .chat-bubble-user {
            background-color: #6366F1; /* Nuovo colore primario: Indigo */
            color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .chat-bubble-user:hover {
            transform: scale(1.02); /* Animazione pi√π pronunciata */
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .chat-bubble-bot {
            background-color: #1F2937; /* slate-800 */
            color: #E0E0F0;
            border-radius: 1rem 1rem 1rem 0.25rem;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            border: 1px solid #374151; /* Bordo sottile per separazione */
        }
        .chat-bubble-bot:hover {
            transform: scale(1.02); /* Animazione pi√π pronunciata */
            box-shadow: 0 4px 15px rgba(31, 41, 55, 0.4);
        }
        .chat-bubble-error {
            background-color: #F87171; /* red-400, pi√π morbido */
            color: #1F2937;
        }
        /* Stili Tabella */
        .editable-cell {
            transition: background-color 0.2s;
        }
        .editable-cell:hover {
            background-color: rgba(99, 102, 241, 0.1); /* Nuovo colore primario */
        }
        .text-editable-cell input:focus {
            background: #1F2937;
            border-color: #6366F1;
        }
        .saving-indicator {
            background: #FBBF24; /* amber-400 */
        }
        .saved-indicator {
            background: #34D399; /* emerald-400 */
        }
        /* Stili Login */
        .login-container {
            background: linear-gradient(135deg, #0A0A1A 0%, #1F2937 100%); /* Sfondo pi√π scuro */
        }
        .login-box {
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            background: rgba(31, 41, 55, 0.9); /* slate-800 con opacit√† */
            border: 1px solid #374151; /* slate-700 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Ombra pi√π scura */
            animation: popIn 0.5s ease-out;
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: #111827; /* slate-900 */
            border-radius: 8px;
            padding: 0 15px;
            border: 1px solid #374151;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group:focus-within {
            border-color: #6366F1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        .input-group svg {
            margin-right: 10px;
            color: #9CA3AF; /* gray-400 */
        }
        .input-group input {
            flex-grow: 1;
            background: transparent;
            border: none;
            padding: 12px 0;
            color: #E0E0F0;
            outline: none;
        }
        .error-message {
            background-color: #450A0A;
            color: #FCA5A5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #B91C1C;
        }
        .login-button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, #6366F1 0%, #818CF8 100%); /* Nuovo gradiente */
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .login-button:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
            transform: translateY(-2px) scale(1.01); /* Animazione pi√π figa */
        }
        .btn-custom-blue {
            background-color: #4B5563; /* gray-600 */
        }
        .btn-custom-blue:hover {
            background-color: #374151; /* gray-700 */
        }
        /* Stili File Upload per Evasore */
        .chat-drag-over {
            background-color: rgba(99, 102, 241, 0.05); /* Nuovo colore primario */
            border: 2px dashed #6366F1;
            border-radius: 12px;
        }
        .uploaded-file-item {
            background-color: #1F2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease-in-out;
        }
        .uploaded-file-item:hover {
            background-color: #374151;
            transform: translateX(5px); /* Animazione di scorrimento */
        }
        .remove-file-btn {
            color: #F87171;
            cursor: pointer;
            transition: color 0.2s;
        }
        .remove-file-btn:hover {
            color: #EF4444;
            transform: scale(1.1);
        }
        /* Animazione cambio vista */
        .view-transition {
            animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        /* Stili aggiuntivi per il tema scuro */
        .bg-slate-900 {
            background-color: #111827; /* Tailwind slate-900 */
        }
        .bg-slate-800 {
            background-color: #1F2937; /* Tailwind slate-800 */
        }
        .bg-slate-700 {
            background-color: #334155; /* Tailwind slate-700 */
        }
        .text-slate-200 {
            color: #E2E8F0; /* Tailwind slate-200 */
        }
        .text-sky-500 {
            color: #6366F1; /* Sostituito con Indigo */
        }
        .bg-sky-500 {
            background-color: #6366F1; /* Sostituito con Indigo */
        }
        .hover\:bg-sky-600:hover {
            background-color: #4F46E5; /* Sostituito con Indigo-600 */
        }
        .border-sky-500 {
            border-color: #6366F1; /* Sostituito con Indigo */
        }
        .shadow-sky-500\/50 {
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.5), 0 4px 6px -2px rgba(99, 102, 241, 0.05);
        }
        /* Override per il contenitore principale per un tema pi√π scuro */
        #appContainer {
            background-color: #111827; /* Sfondo principale dell'app */
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }
        /* Stile per la barra laterale */
        #sidebar {
            background-color: #1F2937; /* Sfondo barra laterale */
            border-right: 1px solid #374151;
        }
        /* Stile per l'area principale della chat */
        #chatArea {
            background-color: #111827; /* Sfondo area chat */
        }
        /* Stile per il footer/input */
        #chatFooter {
            background-color: #111827;
            border-top: 1px solid #374151;
        }
        /* Stile per il contenitore dei messaggi */
        #messagesContainer {
            background-color: #111827;
        }
        /* Stile per il modale */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px); /* Blur pi√π forte */
        }
        .modal-content {
            background-color: #1F2937;
            border: 1px solid #374151;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .edit-modal-content {
            background-color: #1F2937;
            border: 1px solid #374151;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .edit-textarea {
            background-color: #111827;
            border: 1px solid #374151;
        }
        .edit-textarea:focus {
            border-color: #6366F1;
        }
        /* Animazione per il pulsante di invio */
        #sendButton {
            transition: all 0.2s ease-in-out;
        }
        #sendButton:hover {
            transform: scale(1.1);
            filter: brightness(1.1);
        }
        /* Animazione per i pulsanti di navigazione */
        .nav-item-icon {
            transition: transform 0.3s ease-in-out;
        }
        .nav-item:hover .nav-item-icon {
            transform: translateX(5px);
        }
        /* Animazione per il pulsante di logout */
        #logoutBtn {
            transition: all 0.3s ease-in-out;
        }
        #logoutBtn:hover {
            background-color: #EF4444; /* red-500 */
            color: white;
            transform: scale(1.05);
        }
        /* Animazione per il pulsante Impostazioni */
        #settingsBtn {
            transition: transform 0.5s ease-in-out;
        }
        #settingsBtn:hover {
            transform: rotate(90deg);
        }
        /* Animazione per il pulsante Cancella Chat */
        #clearChatBtn {
            transition: transform 0.3s ease-in-out;
        }
        #clearChatBtn:hover {
            transform: rotate(-5deg) scale(1.05);
        }
        /* Stili per la tabella */
        .table-header {
            background-color: #374151; /* gray-700 */
            color: #E0E0F0;
        }
        .table-row:nth-child(even) {
            background-color: #1F2937; /* slate-800 */
        }
        .table-row:nth-child(odd) {
            background-color: #111827; /* slate-900 */
        }
        .table-row {
            transition: background-color 0.2s;
        }
        .table-row:hover {
            background-color: #374151 !important; /* gray-700 */
        }
        .delete-row-btn:hover {
            transform: scale(1.2);
        }
        /* Stili per i pulsanti di stato */
        .status-annullare {
            background-color: #F87171; /* red-400 */
            color: #1F2937;
        }
        .status-annullare:hover {
            background-color: #EF4444; /* red-500 */
        }
        .status-rispedire {
            background-color: #34D399; /* emerald-400 */
            color: #1F2937;
        }
        .status-rispedire:hover {
            background-color: #10B981; /* emerald-500 */
        }
        .status-attesa {
            background-color: #FBBF24; /* amber-400 */
            color: #1F2937;
        }
        .status-attesa:hover {
            background-color: #F59E0B; /* amber-500 */
        }
        .status-option-btn {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .status-option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <!-- Schermata di Login -->
    <div id="loginScreen" class="login-container fixed inset-0 flex items-center justify-center z-50">
        <div class="login-box bg-slate-800 text-white shadow-2xl">
            <div class="flex justify-center mb-6">
                <svg class="w-16 h-16 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
            </div>
            <h2 class="text-3xl font-bold text-center mb-2">Accesso Piattaforma</h2>
            <p class="text-center text-slate-400 mb-8">Inserisci le tue credenziali</p>

            <div id="errorMessage" class="error-message hidden" role="alert"></div>

            <form id="loginForm">
                <div class="input-group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <input id="username" type="text" placeholder="Nome utente" required>
                </div>
                <div class="input-group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 9a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <input id="password" type="password" placeholder="Password" required>
                </div>
                <button id="loginButton" type="submit" class="login-button bg-sky-500 text-white mt-4">
                    Accedi
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Contenitore Principale dell'App -->
    <div id="appContainer" class="hidden h-screen flex bg-slate-900 text-slate-200">
        
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 flex flex-col bg-slate-800 border-r border-slate-700 shadow-xl">
            <div class="p-4 border-b border-slate-700">
                <h1 class="text-2xl font-bold text-sky-500">FenixHome</h1>
                <p class="text-sm text-slate-400 mt-1">Utente: <span id="currentUser"></span> (<span id="currentRole"></span>)</p>
            </div>
            
            <!-- Navigazione -->
            <nav class="flex-grow p-4 space-y-2">
                <button id="navChatLella" class="nav-item w-full flex items-center p-3 text-left text-slate-200 font-semibold active">
                    <svg class="w-5 h-5 mr-3 nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    Chat - Lella
                </button>
                <button id="navChatEvasore" class="nav-item w-full flex items-center p-3 text-left text-slate-200 font-semibold">
                    <svg class="w-5 h-5 mr-3 nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Evasore
                </button>
                <button id="navChatGodOfReturns" class="nav-item w-full flex items-center p-3 text-left text-slate-200 font-semibold">
                    <svg class="w-5 h-5 mr-3 nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.519 4.674c.3.921-.755 1.688-1.539 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.784.57-1.838-.197-1.539-1.118l1.519-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.382-1.81.588-1.81h4.915a1 1 0 00.95-.69l1.519-4.674z"></path></svg>
                    God of Returns
                </button>
                <button id="navTableLella" class="nav-item w-full flex items-center p-3 text-left text-slate-200 font-semibold">
                    <svg class="w-5 h-5 mr-3 nav-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    Tabella - Lella
                </button>
            </nav>

            <!-- Footer Sidebar -->
            <div class="p-4 border-t border-slate-700 space-y-2">
                <button id="settingsBtn" class="nav-item w-full flex items-center p-3 text-left text-slate-200 font-semibold">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    ‚öôÔ∏è Impostazioni
                </button>
                <button id="clearChatBtn" class="nav-item w-full flex items-center p-3 text-left text-slate-200 font-semibold">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    üóëÔ∏è Cancella Chat
                </button>
                <button id="logoutBtn" class="nav-item w-full flex items-center p-3 text-left text-red-400 font-semibold">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    üö™ Logout
                </button>
            </div>
        </div>

        <!-- Area Principale -->
        <div id="mainArea" class="flex-grow flex flex-col">
            
            <!-- Contenitore Viste -->
            <div id="viewContainer" class="flex-grow overflow-hidden">
                
                <!-- Chat Lella View -->
                <div id="chatLellaView" class="h-full flex flex-col view-transition">
                    <header class="p-4 border-b border-slate-700 bg-slate-800 flex items-center">
                        <svg class="w-6 h-6 mr-3 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                        <h2 class="text-xl font-semibold">Chat - Lella</h2>
                    </header>
                    <div id="messagesContainerLella" class="flex-grow overflow-y-auto p-6 space-y-4 bg-slate-900">
                        <div class="flex justify-center items-center h-full text-slate-400 text-center">
                            <div>
                                <span class="text-4xl mb-4 block">üëã</span>
                                <p class="text-lg font-medium">Benvenuto!</p>
                                <p>Invia un messaggio per iniziare a comunicare</p>
                            </div>
                        </div>
                    </div>
                    <footer id="chatFooter" class="p-4 border-t border-slate-700 bg-slate-900">
                        <div class="flex items-end space-x-3">
                            <textarea id="messageInputLella" class="flex-grow p-3 border border-slate-700 rounded-xl resize-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-slate-200" placeholder="Scrivi un messaggio..." rows="1"></textarea>
                            <button id="sendButtonLella" class="p-3 bg-sky-500 text-white rounded-full shadow-lg hover:bg-sky-600 transition duration-200 transform hover:scale-110">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            </button>
                        </div>
                    </footer>
                </div>

                <!-- Chat Evasore View -->
                <div id="chatEvasoreView" class="hidden h-full flex flex-col view-transition">
                    <header class="p-4 border-b border-slate-700 bg-slate-800 flex items-center">
                        <svg class="w-6 h-6 mr-3 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h2 class="text-xl font-semibold">Evasore</h2>
                    </header>
                    <div id="messagesContainerEvasore" class="flex-grow overflow-y-auto p-6 space-y-4 bg-slate-900">
                        <div class="flex justify-center items-center h-full text-slate-400 text-center">
                            <div>
                                <span class="text-4xl mb-4 block">‚è≥</span>
                                <p class="text-lg font-medium">In attesa di istruzioni...</p>
                                <p>Trascina e rilascia i file o scrivi un messaggio per iniziare.</p>
                            </div>
                        </div>
                    </div>
                    <footer class="p-4 border-t border-slate-700 bg-slate-900">
                        <div id="fileDropArea" class="border-2 border-dashed border-slate-700 rounded-xl p-4 text-center mb-4 cursor-pointer transition duration-200 hover:border-sky-500">
                            <p class="text-slate-400">Trascina e rilascia i file qui, o <span class="text-sky-500 font-semibold">clicca per selezionare</span></p>
                            <input type="file" id="fileInputEvasore" multiple class="hidden">
                        </div>
                        <div id="uploadedFilesContainer" class="mb-4">
                            <!-- I file caricati verranno inseriti qui -->
                        </div>
                        <div class="flex items-end space-x-3">
                            <textarea id="messageInputEvasore" class="flex-grow p-3 border border-slate-700 rounded-xl resize-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-slate-200" placeholder="Scrivi un messaggio..." rows="1"></textarea>
                            <button id="sendButtonEvasore" class="p-3 bg-sky-500 text-white rounded-full shadow-lg hover:bg-sky-600 transition duration-200 transform hover:scale-110">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            </button>
                        </div>
                    </footer>
                </div>

                <!-- Chat God of Returns View -->
                <div id="chatGodOfReturnsView" class="hidden h-full flex flex-col view-transition">
                    <header class="p-4 border-b border-slate-700 bg-slate-800 flex items-center">
                        <svg class="w-6 h-6 mr-3 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.519 4.674c.3.921-.755 1.688-1.539 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.784.57-1.838-.197-1.539-1.118l1.519-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.382-1.81.588-1.81h4.915a1 1 0 00.95-.69l1.519-4.674z"></path></svg>
                        <h2 class="text-xl font-semibold">God of Returns</h2>
                    </header>
                    <div id="messagesContainerGodOfReturns" class="flex-grow overflow-y-auto p-6 space-y-4 bg-slate-900">
                        <div class="flex justify-center items-center h-full text-slate-400 text-center">
                            <div>
                                <span class="text-4xl mb-4 block">‚≠ê</span>
                                <p class="text-lg font-medium">Pronto per la gloria!</p>
                                <p>Invia un messaggio per iniziare a comunicare</p>
                            </div>
                        </div>
                    </div>
                    <footer class="p-4 border-t border-slate-700 bg-slate-900">
                        <div class="flex items-end space-x-3">
                            <textarea id="messageInputGodOfReturns" class="flex-grow p-3 border border-slate-700 rounded-xl resize-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 bg-slate-800 text-slate-200" placeholder="Scrivi un messaggio..." rows="1"></textarea>
                            <button id="sendButtonGodOfReturns" class="p-3 bg-sky-500 text-white rounded-full shadow-lg hover:bg-sky-600 transition duration-200 transform hover:scale-110">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            </button>
                        </div>
                    </footer>
                </div>

                <!-- Tabella Lella View -->
                <div id="tableLellaView" class="hidden h-full flex flex-col view-transition">
                    <header class="p-4 border-b border-slate-700 bg-slate-800 flex items-center justify-between">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 mr-3 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            <h2 class="text-xl font-semibold">Tabella - Lella</h2>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="tableStatus" class="text-sm font-medium text-slate-400"></span>
                            <button id="refreshTableBtn" class="p-2 bg-slate-700 text-slate-200 rounded-full hover:bg-slate-600 transition duration-200 transform hover:rotate-180">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                            <button id="deleteTableBtn" class="p-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition duration-200 transform hover:scale-110">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </header>
                    <div class="flex-grow overflow-y-auto p-6 bg-slate-900">
                        <div id="tableContainer" class="overflow-x-auto rounded-lg shadow-xl">
                            <table id="dataTable" class="min-w-full divide-y divide-slate-700">
                                <thead class="table-header">
                                    <tr>
                                        <!-- Le intestazioni verranno generate qui -->
                                    </tr>
                                </thead>
                                <tbody id="tableBody" class="divide-y divide-slate-800">
                                    <!-- I dati verranno generati qui -->
                                </tbody>
                            </table>
                            <div id="tableLoading" class="p-4 text-center text-sky-500 font-semibold hidden">Caricamento dati...</div>
                            <div id="tableError" class="p-4 text-center text-red-400 font-semibold hidden">Errore nel caricamento della tabella: <span id="tableErrorMessage"></span></div>
                            <div id="tableEmpty" class="p-4 text-center text-slate-400 font-semibold hidden">
                                <span class="text-4xl mb-4 block">üì≠</span>
                                Nessun dato trovato. La tabella √® vuota. Invia un messaggio alla chat per popolarla.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Impostazioni View -->
                <div id="settingsView" class="hidden h-full flex flex-col view-transition">
                    <header class="p-4 border-b border-slate-700 bg-slate-800 flex items-center">
                        <svg class="w-6 h-6 mr-3 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <h2 class="text-xl font-semibold">Configurazione API</h2>
                    </header>
                    <div class="flex-grow overflow-y-auto p-6 space-y-8 bg-slate-900">
                        
                        <!-- Autenticazione -->
                        <section>
                            <h3 class="text-2xl font-bold border-b border-slate-700 pb-2 mb-4 text-sky-500">Autenticazione</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="apiLogin" class="block text-sm font-medium text-slate-400 mb-1">API Login:</label>
                                    <input type="text" id="apiLogin" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL API Login">
                                </div>
                            </div>
                        </section>

                        <!-- Webhooks Chat -->
                        <section>
                            <h3 class="text-2xl font-bold border-b border-slate-700 pb-2 mb-4 text-sky-500">Webhooks Chat</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="webhookLella" class="block text-sm font-medium text-slate-400 mb-1">Webhook Chat Lella:</label>
                                    <input type="text" id="webhookLella" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL Webhook Lella">
                                </div>
                                <div>
                                    <label for="webhookEvasoreText" class="block text-sm font-medium text-slate-400 mb-1">Webhook Chat Evasore (Testo):</label>
                                    <input type="text" id="webhookEvasoreText" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL Webhook Evasore (Testo)">
                                </div>
                                <div>
                                    <label for="webhookEvasoreFile" class="block text-sm font-medium text-slate-400 mb-1">Webhook Chat Evasore (File):</label>
                                    <input type="text" id="webhookEvasoreFile" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL Webhook Evasore (File)">
                                </div>
                                <div>
                                    <label for="webhookGodOfReturns" class="block text-sm font-medium text-slate-400 mb-1">Webhook Chat God of Returns:</label>
                                    <input type="text" id="webhookGodOfReturns" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL Webhook God of Returns">
                                </div>
                            </div>
                        </section>

                        <!-- API Tabella -->
                        <section>
                            <h3 class="text-2xl font-bold border-b border-slate-700 pb-2 mb-4 text-sky-500">API Tabella</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="apiTableLoad" class="block text-sm font-medium text-slate-400 mb-1">API Tabella (Caricamento Dati):</label>
                                    <input type="text" id="apiTableLoad" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL API Caricamento Dati">
                                </div>
                                <div>
                                    <label for="apiTableCellEdit" class="block text-sm font-medium text-slate-400 mb-1">API Modifica Cella:</label>
                                    <input type="text" id="apiTableCellEdit" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL API Modifica Cella">
                                </div>
                                <div>
                                    <label for="apiTableDelete" class="block text-sm font-medium text-slate-400 mb-1">API Elimina Tabella:</label>
                                    <input type="text" id="apiTableDelete" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL API Elimina Tabella">
                                </div>
                                <div>
                                    <label for="apiTableRowDelete" class="block text-sm font-medium text-slate-400 mb-1">API Elimina Riga:</label>
                                    <input type="text" id="apiTableRowDelete" class="w-full p-3 rounded-lg bg-slate-800 border border-slate-700 focus:ring-sky-500 focus:border-sky-500" placeholder="URL API Elimina Riga">
                                </div>
                            </div>
                        </section>

                        <div class="flex justify-end">
                            <button id="saveSettingsBtn" class="p-3 bg-sky-500 text-white rounded-lg font-semibold hover:bg-sky-600 transition duration-200 transform hover:scale-105">
                                Salva Impostazioni
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modale per la modifica della cella -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="edit-modal-content">
            <h3 class="text-xl font-bold mb-6 text-sky-500">Modifica Contenuto Cella</h3>
            <textarea id="editModalTextarea" class="edit-textarea flex-grow mb-4 bg-slate-900 border border-slate-700"></textarea>
            <div class="flex justify-end space-x-3">
                <button id="cancelEditBtn" class="p-2 px-4 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition duration-200">Annulla</button>
                <button id="saveEditBtn" class="p-2 px-4 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition duration-200">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modale per la modifica dello stato -->
    <div id="statusModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-6 text-sky-500">Modifica Stato</h3>
            <div class="space-y-3">
                <button data-status="annullare" class="status-option-btn status-annullare">Annullare</button>
                <button data-status="rispedire" class="status-option-btn status-rispedire">Rispedire</button>
                <button data-status="attesa" class="status-option-btn status-attesa">In Attesa</button>
            </div>
            <div class="flex justify-end mt-6">
                <button id="cancelStatusBtn" class="p-2 px-4 bg-slate-700 text-white rounded-lg hover:bg-slate-600 transition duration-200">Annulla</button>
            </div>
        </div>
    </div>

    <script>
        // Inizio del codice JavaScript originale
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('errorMessage');
        const currentUserSpan = document.getElementById('currentUser');
        const currentRoleSpan = document.getElementById('currentRole');
        const navItems = document.querySelectorAll('.nav-item');
        const viewContainer = document.getElementById('viewContainer');
        const views = {
            chatLella: document.getElementById('chatLellaView'),
            chatEvasore: document.getElementById('chatEvasoreView'),
            chatGodOfReturns: document.getElementById('chatGodOfReturnsView'),
            tableLella: document.getElementById('tableLellaView'),
            settings: document.getElementById('settingsView')
        };
        const navButtons = {
            chatLella: document.getElementById('navChatLella'),
            chatEvasore: document.getElementById('navChatEvasore'),
            chatGodOfReturns: document.getElementById('navChatGodOfReturns'),
            tableLella: document.getElementById('navTableLella'),
            settings: document.getElementById('settingsBtn')
        };
        const logoutBtn = document.getElementById('logoutBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const refreshTableBtn = document.getElementById('refreshTableBtn');
        const deleteTableBtn = document.getElementById('deleteTableBtn');
        const tableStatusSpan = document.getElementById('tableStatus');

        // Chat elements
        const messagesContainerLella = document.getElementById('messagesContainerLella');
        const messageInputLella = document.getElementById('messageInputLella');
        const sendButtonLella = document.getElementById('sendButtonLella');
        
        const messagesContainerEvasore = document.getElementById('messagesContainerEvasore');
        const messageInputEvasore = document.getElementById('messageInputEvasore');
        const sendButtonEvasore = document.getElementById('sendButtonEvasore');
        const fileInputEvasore = document.getElementById('fileInputEvasore');
        const fileDropArea = document.getElementById('fileDropArea');
        const uploadedFilesContainer = document.getElementById('uploadedFilesContainer');
        
        const messagesContainerGodOfReturns = document.getElementById('messagesContainerGodOfReturns');
        const messageInputGodOfReturns = document.getElementById('messageInputGodOfReturns');
        const sendButtonGodOfReturns = document.getElementById('sendButtonGodOfReturns');

        // Table elements
        const dataTable = document.getElementById('dataTable');
        const tableBody = document.getElementById('tableBody');
        const tableLoading = document.getElementById('tableLoading');
        const tableError = document.getElementById('tableError');
        const tableErrorMessageSpan = document.getElementById('tableErrorMessage');
        const tableEmpty = document.getElementById('tableEmpty');

        // Modal elements
        const editModal = document.getElementById('editModal');
        const editModalTextarea = document.getElementById('editModalTextarea');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        
        const statusModal = document.getElementById('statusModal');
        const statusOptionBtns = document.querySelectorAll('.status-option-btn');
        const cancelStatusBtn = document.getElementById('cancelStatusBtn');

        // API Settings elements
        const apiLoginInput = document.getElementById('apiLogin');
        const webhookLellaInput = document.getElementById('webhookLella');
        const webhookEvasoreTextInput = document.getElementById('webhookEvasoreText');
        const webhookEvasoreFileInput = document.getElementById('webhookEvasoreFile');
        const webhookGodOfReturnsInput = document.getElementById('webhookGodOfReturns');
        const apiTableLoadInput = document.getElementById('apiTableLoad');
        const apiTableCellEditInput = document.getElementById('apiTableCellEdit');
        const apiTableDeleteInput = document.getElementById('apiTableDelete');
        const apiTableRowDeleteInput = document.getElementById('apiTableRowDelete');

        // Variabili di stato
        let isAuthenticated = false;
        let currentView = 'chatLella';
        let currentTableData = [];
        let currentEditCell = null;
        let currentStatusRow = null;
        let uploadedFiles = [];
        let apiSettings = {};

        // Funzioni di utilit√†
        function showView(viewName) {
            if (views[viewName]) {
                // Rimuovi la classe 'active' da tutti i pulsanti di navigazione
                navItems.forEach(item => item.classList.remove('active'));
                
                // Nascondi tutte le viste
                Object.values(views).forEach(view => view.classList.add('hidden'));
                
                // Mostra la vista desiderata
                views[viewName].classList.remove('hidden');
                currentView = viewName;

                // Aggiungi la classe 'active' al pulsante di navigazione corrispondente
                if (navButtons[viewName]) {
                    navButtons[viewName].classList.add('active');
                } else if (viewName === 'settings') {
                    // Il pulsante impostazioni non √® un nav-item standard ma lo gestiamo
                    navButtons.settings.classList.add('active');
                }

                // Se la vista √® la tabella, carichiamo i dati
                if (viewName === 'tableLella') {
                    loadTableData();
                }
            }
        }

        function saveSettings() {
            apiSettings = {
                apiLogin: apiLoginInput.value,
                webhookLella: webhookLellaInput.value,
                webhookEvasoreText: webhookEvasoreTextInput.value,
                webhookEvasoreFile: webhookEvasoreFileInput.value,
                webhookGodOfReturns: webhookGodOfReturnsInput.value,
                apiTableLoad: apiTableLoadInput.value,
                apiTableCellEdit: apiTableCellEditInput.value,
                apiTableDelete: apiTableDeleteInput.value,
                apiTableRowDelete: apiTableRowDeleteInput.value
            };
            localStorage.setItem('apiSettings', JSON.stringify(apiSettings));
            alert('Impostazioni salvate con successo!');
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('apiSettings');
            if (savedSettings) {
                apiSettings = JSON.parse(savedSettings);
                apiLoginInput.value = apiSettings.apiLogin || '';
                webhookLellaInput.value = apiSettings.webhookLella || '';
                webhookEvasoreTextInput.value = apiSettings.webhookEvasoreText || '';
                webhookEvasoreFileInput.value = apiSettings.webhookEvasoreFile || '';
                webhookGodOfReturnsInput.value = apiSettings.webhookGodOfReturns || '';
                apiTableLoadInput.value = apiSettings.apiTableLoad || '';
                apiTableCellEditInput.value = apiSettings.apiTableCellEdit || '';
                apiTableDeleteInput.value = apiSettings.apiTableDelete || '';
                apiTableRowDeleteInput.value = apiSettings.apiTableRowDelete || '';
            }
        }

        function showLoginError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            // Animazione di scuotimento
            errorMessage.style.animation = 'shake 0.5s';
            setTimeout(() => errorMessage.style.animation = '', 500);
        }

        function hideLoginError() {
            errorMessage.classList.add('hidden');
        }

        function login(username, role) {
            isAuthenticated = true;
            currentUserSpan.textContent = username;
            currentRoleSpan.textContent = role;
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            showView('chatLella');
            loadSettings();
        }

        function logout() {
            isAuthenticated = false;
            localStorage.removeItem('userToken');
            loginScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
            hideLoginError();
            // Pulisci i campi di login
            usernameInput.value = '';
            passwordInput.value = '';
        }

        function createMessageElement(message, isUser, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'message-enter');
            messageDiv.classList.add(isUser ? 'justify-end' : 'justify-start');

            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('max-w-xl', 'p-3', 'rounded-xl', 'shadow-md');
            bubbleDiv.classList.add(isUser ? 'chat-bubble-user' : 'chat-bubble-bot');
            
            if (isError) {
                bubbleDiv.classList.add('chat-bubble-error');
            }

            const content = document.createElement('p');
            content.textContent = message;
            content.classList.add('whitespace-pre-wrap');

            bubbleDiv.appendChild(content);
            messageDiv.appendChild(bubbleDiv);
            return messageDiv;
        }

        function addMessage(container, message, isUser, isError = false) {
            const messageElement = createMessageElement(message, isUser, isError);
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        function addTypingIndicator(container) {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.classList.add('flex', 'justify-start', 'message-enter');
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('max-w-xl', 'p-3', 'rounded-xl', 'shadow-md', 'chat-bubble-bot', 'flex', 'items-center', 'space-x-2');
            
            const spinner = document.createElement('div');
            spinner.classList.add('spinner');
            
            const text = document.createElement('p');
            text.textContent = 'Sta scrivendo...';
            
            bubbleDiv.appendChild(spinner);
            bubbleDiv.appendChild(text);
            typingDiv.appendChild(bubbleDiv);
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator(container) {
            const indicator = container.querySelector('#typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function sendMessage(message, webhookUrl, container, inputElement, fileUpload = false) {
            if (!message.trim() && !fileUpload) return;

            addMessage(container, message, true);
            inputElement.value = '';
            inputElement.style.height = '48px'; // Reset textarea height

            addTypingIndicator(container);

            try {
                const payload = {
                    message: message,
                    user: currentUserSpan.textContent,
                    role: currentRoleSpan.textContent
                };

                if (fileUpload) {
                    payload.files = uploadedFiles.map(file => ({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        base64: file.base64 // In un'applicazione reale, invieresti un URL o un ID
                    }));
                    uploadedFiles = [];
                    uploadedFilesContainer.innerHTML = '';
                }

                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                    },
                    body: JSON.stringify(payload)
                });

                removeTypingIndicator(container);

                if (!response.ok) {
                    const errorText = await response.text();
                    addMessage(container, `Errore API: ${response.status} - ${errorText}`, false, true);
                    return;
                }

                const data = await response.json();
                addMessage(container, data.response || 'Nessuna risposta dal bot.', false);

            } catch (error) {
                removeTypingIndicator(container);
                addMessage(container, `Errore di rete: ${error.message}`, false, true);
            }
        }

        // Funzioni Tabella
        function renderTable(data) {
            currentTableData = data;
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableEmpty.classList.remove('hidden');
                dataTable.classList.add('hidden');
                return;
            }

            tableEmpty.classList.add('hidden');
            dataTable.classList.remove('hidden');

            // Genera intestazioni (assumendo che tutti gli oggetti abbiano le stesse chiavi)
            const headers = Object.keys(data[0]);
            const headerRow = dataTable.querySelector('thead tr');
            headerRow.innerHTML = '';
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.toUpperCase();
                th.classList.add('p-3', 'text-left', 'text-xs', 'font-medium', 'uppercase', 'tracking-wider');
                headerRow.appendChild(th);
            });
            // Aggiungi colonna Azioni
            const thActions = document.createElement('th');
            thActions.textContent = 'AZIONI';
            thActions.classList.add('p-3', 'text-left', 'text-xs', 'font-medium', 'uppercase', 'tracking-wider');
            headerRow.appendChild(thActions);

            // Genera righe
            data.forEach((rowData, rowIndex) => {
                const row = document.createElement('tr');
                row.classList.add('table-row');
                row.dataset.id = rowData.id; // Assumendo che ogni riga abbia un ID

                headers.forEach((header, colIndex) => {
                    const cell = document.createElement('td');
                    cell.classList.add('p-3', 'whitespace-nowrap', 'text-sm', 'editable-cell');
                    cell.dataset.row = rowIndex;
                    cell.dataset.col = header;
                    cell.dataset.value = rowData[header];

                    if (header.toLowerCase() === 'stato') {
                        // Cella Stato con pulsante
                        const statusBtn = document.createElement('button');
                        statusBtn.textContent = rowData[header];
                        statusBtn.classList.add('p-1', 'px-3', 'rounded-full', 'text-xs', 'font-semibold', 'shadow-md', 'transition', 'duration-200');
                        statusBtn.classList.add(`status-${rowData[header].toLowerCase().replace(/\s/g, '')}`);
                        statusBtn.onclick = (e) => {
                            e.stopPropagation();
                            openStatusModal(row, header, rowData[header]);
                        };
                        cell.appendChild(statusBtn);
                    } else {
                        // Cella di testo modificabile
                        cell.textContent = rowData[header];
                        cell.onclick = (e) => {
                            e.stopPropagation();
                            openEditModal(cell);
                        };
                    }
                    row.appendChild(cell);
                });

                // Colonna Azioni
                const actionsCell = document.createElement('td');
                actionsCell.classList.add('p-3', 'whitespace-nowrap', 'text-sm');
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-row-btn', 'hover:text-red-500', 'transition', 'duration-200');
                deleteBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
                deleteBtn.title = 'Elimina Riga';
                deleteBtn.onclick = () => deleteTableRow(rowData.id);
                actionsCell.appendChild(deleteBtn);
                row.appendChild(actionsCell);

                tableBody.appendChild(row);
            });
        }

        function showTableLoading() {
            tableLoading.classList.remove('hidden');
            tableError.classList.add('hidden');
            tableEmpty.classList.add('hidden');
            dataTable.classList.add('hidden');
            tableStatusSpan.textContent = 'Caricamento...';
        }

        function showTableError(message) {
            tableLoading.classList.add('hidden');
            tableError.classList.remove('hidden');
            tableErrorMessageSpan.textContent = message;
            tableEmpty.classList.add('hidden');
            dataTable.classList.add('hidden');
            tableStatusSpan.textContent = 'Errore';
        }

        function showTableLoaded(count) {
            tableLoading.classList.add('hidden');
            tableError.classList.add('hidden');
            tableStatusSpan.textContent = `Caricati ${count} elementi`;
        }

        async function loadTableData() {
            if (!apiSettings.apiTableLoad) {
                showTableError('URL API Caricamento Dati non configurato nelle Impostazioni.');
                return;
            }

            showTableLoading();

            try {
                const response = await fetch(apiSettings.apiTableLoad, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.length === 0) {
                    tableEmpty.classList.remove('hidden');
                    dataTable.classList.add('hidden');
                    showTableLoaded(0);
                } else {
                    renderTable(data);
                    showTableLoaded(data.length);
                }

            } catch (error) {
                console.error('Errore nel caricamento della tabella:', error);
                showTableError(error.message);
            }
        }

        async function deleteTable() {
            if (!apiSettings.apiTableDelete) {
                alert('URL API Elimina Tabella non configurato nelle Impostazioni.');
                return;
            }

            if (!confirm('Sei sicuro di voler eliminare l\'intera tabella? Questa azione √® irreversibile.')) {
                return;
            }

            try {
                const response = await fetch(apiSettings.apiTableDelete, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                alert('Tabella eliminata con successo!');
                loadTableData(); // Ricarica la tabella vuota

            } catch (error) {
                console.error('Errore nell\'eliminazione della tabella:', error);
                alert(`Errore nell\'eliminazione della tabella: ${error.message}`);
            }
        }

        async function deleteTableRow(rowId) {
            if (!apiSettings.apiTableRowDelete) {
                alert('URL API Elimina Riga non configurato nelle Impostazioni.');
                return;
            }

            if (!confirm(`Sei sicuro di voler eliminare la riga con ID ${rowId}?`)) {
                return;
            }

            try {
                const response = await fetch(apiSettings.apiTableRowDelete, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                    },
                    body: JSON.stringify({ id: rowId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                alert(`Riga con ID ${rowId} eliminata con successo!`);
                loadTableData(); // Ricarica la tabella

            } catch (error) {
                console.error('Errore nell\'eliminazione della riga:', error);
                alert(`Errore nell\'eliminazione della riga: ${error.message}`);
            }
        }

        function openEditModal(cell) {
            currentEditCell = cell;
            editModalTextarea.value = cell.dataset.value;
            editModal.classList.remove('hidden');
            editModalTextarea.focus();
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
            currentEditCell = null;
        }

        async function saveEdit() {
            if (!currentEditCell) return;
            if (!apiSettings.apiTableCellEdit) {
                alert('URL API Modifica Cella non configurato nelle Impostazioni.');
                return;
            }

            const newValue = editModalTextarea.value;
            const rowId = currentEditCell.closest('tr').dataset.id;
            const columnName = currentEditCell.dataset.col;

            // Mostra indicatore di salvataggio
            const originalContent = currentEditCell.innerHTML;
            currentEditCell.innerHTML = `<div class="flex items-center"><div class="spinner"></div><span class="ml-2 text-xs text-yellow-400">Salvataggio...</span></div>`;
            currentEditCell.classList.add('saving-indicator');

            closeEditModal();

            try {
                const response = await fetch(apiSettings.apiTableCellEdit, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                    },
                    body: JSON.stringify({
                        id: rowId,
                        column: columnName,
                        value: newValue
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Aggiorna la cella con il nuovo valore e l'indicatore di salvato
                currentEditCell.textContent = newValue;
                currentEditCell.dataset.value = newValue;
                currentEditCell.classList.remove('saving-indicator');
                currentEditCell.classList.add('saved-indicator');
                setTimeout(() => {
                    currentEditCell.classList.remove('saved-indicator');
                }, 1500);

            } catch (error) {
                console.error('Errore nel salvataggio della cella:', error);
                // Ripristina il contenuto originale e mostra un errore
                currentEditCell.innerHTML = originalContent;
                currentEditCell.classList.remove('saving-indicator');
                alert(`Errore nel salvataggio: ${error.message}`);
            }
        }

        function openStatusModal(row, column, currentValue) {
            currentStatusRow = { row, column, currentValue };
            statusModal.classList.remove('hidden');
            
            // Evidenzia lo stato corrente
            statusOptionBtns.forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-sky-500', 'ring-offset-slate-900');
                if (btn.dataset.status.toLowerCase() === currentValue.toLowerCase()) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-sky-500', 'ring-offset-slate-900');
                }
            });
        }

        function closeStatusModal() {
            statusModal.classList.add('hidden');
            currentStatusRow = null;
        }

        async function saveStatus(newStatus) {
            if (!currentStatusRow) return;
            if (!apiSettings.apiTableCellEdit) {
                alert('URL API Modifica Cella non configurato nelle Impostazioni.');
                return;
            }

            const { row, column } = currentStatusRow;
            const rowId = row.dataset.id;
            const cell = row.querySelector(`td[data-col="${column}"]`);

            // Mostra indicatore di salvataggio
            const originalContent = cell.innerHTML;
            cell.innerHTML = `<div class="flex items-center justify-center"><div class="spinner"></div></div>`;
            cell.classList.add('saving-indicator');

            closeStatusModal();

            try {
                const response = await fetch(apiSettings.apiTableCellEdit, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('userToken')}`
                    },
                    body: JSON.stringify({
                        id: rowId,
                        column: column,
                        value: newStatus
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Aggiorna la cella con il nuovo valore e l'indicatore di salvato
                const statusBtn = document.createElement('button');
                statusBtn.textContent = newStatus;
                statusBtn.classList.add('p-1', 'px-3', 'rounded-full', 'text-xs', 'font-semibold', 'shadow-md', 'transition', 'duration-200');
                statusBtn.classList.add(`status-${newStatus.toLowerCase().replace(/\s/g, '')}`);
                statusBtn.onclick = (e) => {
                    e.stopPropagation();
                    openStatusModal(row, column, newStatus);
                };
                
                cell.innerHTML = '';
                cell.appendChild(statusBtn);
                cell.dataset.value = newStatus;
                cell.classList.remove('saving-indicator');
                cell.classList.add('saved-indicator');
                setTimeout(() => {
                    cell.classList.remove('saved-indicator');
                }, 1500);

            } catch (error) {
                console.error('Errore nel salvataggio dello stato:', error);
                // Ripristina il contenuto originale e mostra un errore
                cell.innerHTML = originalContent;
                cell.classList.remove('saving-indicator');
                alert(`Errore nel salvataggio dello stato: ${error.message}`);
            }
        }

        // Funzioni Evasore (File Upload)
        function handleFileSelect(event) {
            const files = event.target.files || event.dataTransfer.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedFiles.push({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        base64: e.target.result.split(',')[1] // Solo il contenuto base64
                    });
                    renderUploadedFiles();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeFile(fileName) {
            uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
            renderUploadedFiles();
        }

        function renderUploadedFiles() {
            uploadedFilesContainer.innerHTML = '';
            uploadedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.classList.add('uploaded-file-item');
                fileItem.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a2 2 0 01-2 2h-2.5l-1.5 1.5a1 1 0 01-1.414 0L12 14.414l-1.5 1.5a1 1 0 01-1.414 0L7.5 14H5a2 2 0 01-2-2v-2a2 2 0 012-2h.5"></path></svg>
                        <span class="text-sm font-medium">${file.name}</span>
                        <span class="text-xs text-slate-400">(${(file.size / 1024).toFixed(2)} KB)</span>
                    </div>
                    <button class="remove-file-btn" data-filename="${file.name}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                uploadedFilesContainer.appendChild(fileItem);
            });

            document.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    removeFile(e.currentTarget.dataset.filename);
                });
            });
        }

        // Event Listeners
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideLoginError();
            
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            // Simula l'autenticazione
            if (username === 'manus' && password === 'manus') {
                // In un'applicazione reale, qui faresti una chiamata API per ottenere il token
                localStorage.setItem('userToken', 'simulated_token_12345');
                login(username, 'admin');
            } else {
                // In un'applicazione reale, qui faresti una chiamata API per l'autenticazione
                // Per la simulazione, mostriamo un errore
                showLoginError('Credenziali non valide. Riprova.');
            }
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const viewName = item.id.replace('nav', '').replace('Btn', '');
                showView(viewName.charAt(0).toLowerCase() + viewName.slice(1));
            });
        });

        navButtons.settings.addEventListener('click', () => showView('settings'));
        logoutBtn.addEventListener('click', logout);
        saveSettingsBtn.addEventListener('click', saveSettings);
        refreshTableBtn.addEventListener('click', loadTableData);
        deleteTableBtn.addEventListener('click', deleteTable);

        // Eventi Chat Lella
        sendButtonLella.addEventListener('click', () => {
            sendMessage(messageInputLella.value, apiSettings.webhookLella, messagesContainerLella, messageInputLella);
        });
        messageInputLella.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(messageInputLella.value, apiSettings.webhookLella, messagesContainerLella, messageInputLella);
            }
        });
        messageInputLella.addEventListener('input', () => {
            messageInputLella.style.height = 'auto';
            messageInputLella.style.height = messageInputLella.scrollHeight + 'px';
        });

        // Eventi Chat Evasore
        sendButtonEvasore.addEventListener('click', () => {
            const hasFiles = uploadedFiles.length > 0;
            const webhook = hasFiles ? apiSettings.webhookEvasoreFile : apiSettings.webhookEvasoreText;
            sendMessage(messageInputEvasore.value, webhook, messagesContainerEvasore, messageInputEvasore, hasFiles);
        });
        messageInputEvasore.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const hasFiles = uploadedFiles.length > 0;
                const webhook = hasFiles ? apiSettings.webhookEvasoreFile : apiSettings.webhookEvasoreText;
                sendMessage(messageInputEvasore.value, webhook, messagesContainerEvasore, messageInputEvasore, hasFiles);
            }
        });
        messageInputEvasore.addEventListener('input', () => {
            messageInputEvasore.style.height = 'auto';
            messageInputEvasore.style.height = messageInputEvasore.scrollHeight + 'px';
        });

        // Drag and Drop per Evasore
        fileDropArea.addEventListener('click', () => fileInputEvasore.click());
        fileInputEvasore.addEventListener('change', handleFileSelect);

        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.classList.add('chat-drag-over');
        });
        fileDropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('chat-drag-over');
        });
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('chat-drag-over');
            handleFileSelect(e);
        });

        // Eventi Chat God of Returns
        sendButtonGodOfReturns.addEventListener('click', () => {
            sendMessage(messageInputGodOfReturns.value, apiSettings.webhookGodOfReturns, messagesContainerGodOfReturns, messageInputGodOfReturns);
        });
        messageInputGodOfReturns.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(messageInputGodOfReturns.value, apiSettings.webhookGodOfReturns, messagesContainerGodOfReturns, messageInputGodOfReturns);
            }
        });
        messageInputGodOfReturns.addEventListener('input', () => {
            messageInputGodOfReturns.style.height = 'auto';
            messageInputGodOfReturns.style.height = messageInputGodOfReturns.scrollHeight + 'px';
        });

        // Eventi Modale Modifica Cella
        cancelEditBtn.addEventListener('click', closeEditModal);
        saveEditBtn.addEventListener('click', saveEdit);
        editModalTextarea.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                saveEdit();
            }
        });

        // Eventi Modale Modifica Stato
        cancelStatusBtn.addEventListener('click', closeStatusModal);
        statusOptionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                saveStatus(btn.dataset.status);
            });
        });

        // Evento Cancella Chat
        clearChatBtn.addEventListener('click', () => {
            if (confirm('Sei sicuro di voler cancellare la cronologia della chat corrente?')) {
                const container = document.getElementById(`messagesContainer${currentView.replace('chat', '')}`);
                if (container) {
                    container.innerHTML = `<div class="flex justify-center items-center h-full text-slate-400 text-center">
                        <div>
                            <span class="text-4xl mb-4 block">üëã</span>
                            <p class="text-lg font-medium">Benvenuto!</p>
                            <p>Invia un messaggio per iniziare a comunicare</p>
                        </div>
                    </div>`;
                }
            }
        });

        // Inizializzazione: verifica se l'utente √® gi√† loggato (simulato)
        if (localStorage.getItem('userToken')) {
            // In un'applicazione reale, qui verificheresti il token
            login('manus', 'admin');
        } else {
            loginScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }
    </script>
</body>
</html>
