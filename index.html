<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FenixHome Chat-bot</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* NUOVI COLORI E VARIABILI */
        :root {
            --color-bg-primary: #0A0A0A; /* Quasi nero */
            --color-bg-secondary: #1C1C1C; /* Sfondo elementi */
            --color-bg-tertiary: #2C2C2C; /* Sfondo hover/attivo */
            --color-text-primary: #E0E0E0; /* Testo chiaro */
            --color-text-secondary: #A0A0A0; /* Testo secondario */
            --color-accent: #A020F0; /* Viola (Purple) */
            --color-accent-dark: #8A2BE2;
            --color-shadow: rgba(160, 32, 240, 0.4); /* Ombra viola */
            --color-error: #FF5252;
        }

        /* Stili Base */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
        }

        /* Animazioni e Transizioni */
        .message-enter {
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Easing pi√π fluido */
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .spinner {
            border: 2px solid var(--color-accent);
            border-top: 2px solid var(--color-bg-secondary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-item {
            transition: all 0.3s ease-in-out;
            border-radius: 0.75rem;
            transform: scale(1);
            position: relative;
            overflow: hidden;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--color-accent), transparent);
            transition: all 0.5s ease;
            opacity: 0.1;
        }
        .nav-item:hover {
            background-color: var(--color-bg-tertiary);
            transform: scale(1.02);
            box-shadow: 0 0 5px rgba(160, 32, 240, 0.2);
        }
        .nav-item:hover::before {
            left: 100%;
        }
        .nav-item.active {
            background-color: var(--color-bg-tertiary);
            border-left: 4px solid var(--color-accent);
            box-shadow: 0 0 10px var(--color-shadow);
        }
        .nav-item.active:hover {
            background-color: var(--color-bg-tertiary);
            transform: scale(1.02);
        }
        /* Stili Chat */
        #messageInput {
            min-height: 48px;
            max-height: 150px;
            transition: all 0.2s;
            border: 1px solid var(--color-bg-secondary);
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border-radius: 12px;
            padding: 12px;
        }
        #messageInput:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 8px var(--color-shadow);
        }
        .chat-bubble-user {
            background-color: var(--color-accent);
            color: var(--color-bg-primary);
            border-radius: 1.2rem 1.2rem 0.4rem 1.2rem;
            transition: transform 0.2s ease-out, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .chat-bubble-user:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 4px 10px rgba(160, 32, 240, 0.3);
        }
        .chat-bubble-bot {
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border-radius: 1.2rem 1.2rem 1.2rem 0.4rem;
            transition: transform 0.2s ease-out, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .chat-bubble-bot:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        .chat-bubble-error {
            background-color: var(--color-error);
            color: white;
        }
        /* Stili Tabella */
        .editable-cell {
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .editable-cell:hover {
            background-color: var(--color-bg-tertiary);
            box-shadow: inset 0 0 5px rgba(160, 32, 240, 0.1);
        }
        .text-editable-cell input:focus {
            background: var(--color-bg-secondary);
            border-color: var(--color-accent);
            box-shadow: 0 0 5px var(--color-shadow);
        }
        .saving-indicator {
            background: #F59E0B; /* amber-500 */
        }
        .saved-indicator {
            background: #10B981; /* emerald-500 */
        }
        /* Stili Login */
        .login-container {
            background: radial-gradient(circle at center, #1C1C1C 0%, #0A0A0A 100%);
        }
        .login-box {
            padding: 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-bg-tertiary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.5s ease;
        }
        .login-box:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7), 0 0 20px var(--color-shadow);
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: var(--color-bg-primary);
            border-radius: 10px;
            padding: 0 15px;
            border: 1px solid var(--color-bg-tertiary);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group:focus-within {
            border-color: var(--color-accent);
            box-shadow: 0 0 8px var(--color-shadow);
        }
        .input-group svg {
            margin-right: 10px;
            color: var(--color-text-secondary);
            transition: color 0.3s;
        }
        .input-group:focus-within svg {
            color: var(--color-accent);
        }
        .input-group input {
            flex-grow: 1;
            background: transparent;
            border: none;
            padding: 12px 0;
            color: var(--color-text-primary);
            outline: none;
        }
        .error-message {
            background-color: rgba(255, 82, 82, 0.1);
            color: var(--color-error);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--color-error);
        }
        .login-button {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            background: var(--color-accent);
            color: var(--color-bg-primary);
            box-shadow: 0 4px 15px var(--color-shadow);
            border: none;
        }
        .login-button:hover {
            background: var(--color-accent-dark);
            box-shadow: 0 6px 20px var(--color-shadow);
            transform: translateY(-3px);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(8px); /* Blur aumentato */
        }
        .modal-content {
            background-color: var(--color-bg-secondary);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            max-width: 450px;
            width: 90%;
            border: 1px solid var(--color-bg-tertiary);
            animation: modalFadeIn 0.3s ease-out;
        }
        .edit-modal-content {
            background-color: var(--color-bg-secondary);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            max-width: 600px;
            width: 90%;
            height: 400px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--color-bg-tertiary);
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .edit-textarea {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            resize: none;
            font-family: monospace;
            font-size: 14px;
            color: var(--color-text-primary);
            background-color: var(--color-bg-primary);
            border: 1px solid var(--color-bg-tertiary);
            transition: border-color 0.2s;
        }
        .edit-textarea:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 5px var(--color-shadow);
        }
        .status-option-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            color: var(--color-bg-primary);
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 8px;
            border: none;
        }
        .status-annullare {
            background-color: #FF5252; /* Red A200 */
        }
        .status-annullare:hover {
            background-color: #FF1744; /* Red A400 */
            transform: translateY(-1px);
        }
        .status-rispedire {
            background-color: #00E676; /* Green A700 */
        }
        .status-rispedire:hover {
            background-color: #00C853; /* Green A800 */
            transform: translateY(-1px);
        }
        .status-attesa {
            background-color: #FFC400; /* Amber A400 */
            color: var(--color-bg-primary);
        }
        .status-attesa:hover {
            background-color: #FFAB00; /* Amber A700 */
            transform: translateY(-1px);
        }
        .delete-row-btn {
            color: var(--color-error);
            transition: color 0.2s, transform 0.2s;
        }
        .delete-row-btn:hover {
            color: #FF1744;
            transform: scale(1.1);
        }
        .saving-indicator, .saved-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 1s infinite;
        }
        .saved-indicator {
            animation: none;
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }
        /* Aggiornamento stili per la sidebar e il main content */
        .sidebar {
            background-color: var(--color-bg-secondary);
            border-right: 1px solid var(--color-bg-tertiary);
        }
        .main-content {
            background-color: var(--color-bg-primary);
        }
        .header-bar {
            background-color: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-bg-tertiary);
        }
        .chat-area {
            background-color: var(--color-bg-primary);
        }
        .input-area {
            background-color: var(--color-bg-secondary);
            border-top: 1px solid var(--color-bg-tertiary);
        }
        .btn-custom-blue {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-primary);
        }
        .btn-custom-blue:hover {
            background-color: #404040;
        }
        /* Stili File Upload per Evasore */
        .chat-drag-over {
            background-color: rgba(160, 32, 240, 0.05);
            border: 2px dashed var(--color-accent);
            border-radius: 12px;
        }
        .uploaded-file-item {
            background-color: var(--color-bg-tertiary);
            border: 1px solid #404040;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }
        .uploaded-file-item:hover {
            background-color: #404040;
        }
        .remove-file-btn {
            color: var(--color-error);
            cursor: pointer;
            transition: color 0.2s;
        }
        .remove-file-btn:hover {
            color: #FF1744;
        }
        /* Animazione cambio vista */
        .view-transition {
            animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        /* Stile per il pulsante di invio */
        #sendButton {
            background-color: var(--color-accent);
            color: var(--color-bg-primary);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 10px var(--color-shadow);
        }
        #sendButton:hover {
            background-color: var(--color-accent-dark);
            transform: scale(1.05);
            box-shadow: 0 4px 15px var(--color-shadow);
        }
        /* Stile per l'icona del logo */
        .logo-icon {
            background: linear-gradient(135deg, var(--color-accent) 0%, #8A2BE2 100%);
            box-shadow: 0 0 15px var(--color-shadow);
        }
        /* Stile per le icone della sidebar */
        .nav-icon {
            color: var(--color-text-secondary);
            transition: color 0.3s;
        }
        .nav-item:hover .nav-icon {
            color: var(--color-accent);
        }
        .nav-item.active .nav-icon {
            color: var(--color-accent);
        }
        /* Stile per i titoli */
        .text-accent {
            color: var(--color-accent);
        }
        /* Stile per le intestazioni della tabella */
        .table-header {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-primary);
        }
        /* Stile per le righe della tabella */
        .table-row {
            border-bottom: 1px solid var(--color-bg-tertiary);
        }
        .table-row:nth-child(even) {
            background-color: var(--color-bg-secondary);
        }
        .table-row:nth-child(odd) {
            background-color: var(--color-bg-primary);
        }
        .table-row:hover {
            background-color: var(--color-bg-tertiary);
        }
        /* Stile per i pulsanti generici */
        .btn-primary {
            background-color: var(--color-accent);
            color: var(--color-bg-primary);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--color-accent-dark);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            transition: all 0.3s;
        }
        .btn-secondary:hover {
            background-color: #404040;
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center login-container">
        <div class="login-box">
            <div class="text-center mb-8">
                <div class="w-20 h-20 logo-icon rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Accesso Piattaforma</h1>
                <p class="text-slate-400">Inserisci le tue credenziali</p>
            </div>

            <div id="loginError" class="error-message hidden">
                <span id="loginErrorText"></span>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <input
                        type="text"
                        id="username"
                        placeholder="Nome utente"
                        required
                        autocomplete="username"
                    />
                </div>

                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <input
                        type="password"
                        id="password"
                        placeholder="Password"
                        required
                        autocomplete="current-password"
                    />
                </div>

                <button type="submit" id="loginButton" class="login-button">
                    <span id="loginButtonText">Accedi</span>
                    <div id="loginSpinner" class="spinner hidden mx-auto"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar Navigation -->
            <div class="w-64 sidebar flex flex-col p-3">
                <div class="p-3 border-b border-slate-700 mb-3">
                    <h1 class="text-xl font-extrabold text-white flex items-center gap-2">
                        <div class="w-8 h-8 logo-icon rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        FenixHome
                    </h1>
                    <p class="text-xs text-slate-400 mt-1">Utente: <span id="userInfo"></span></p>
                </div>

                <nav class="flex-grow space-y-1">
                    <button id="navChatLella" class="nav-item w-full flex items-center p-3 text-sm font-medium text-left active">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 nav-icon"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        Chat - Lella
                    </button>
                    <button id="navChatEvasore" class="nav-item w-full flex items-center p-3 text-sm font-medium text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 nav-icon"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
                        Evasore
                    </button>
                    <button id="navChatGodOfReturns" class="nav-item w-full flex items-center p-3 text-sm font-medium text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 nav-icon"><path d="M12 17.75l-6.172 3.245 1.179-6.873-5-4.867 6.908-1.004 3.085-6.257 3.085 6.257 6.908 1.004-5 4.867 1.179 6.873z"></path></svg>
                        God of Returns
                    </button>
                    <button id="navTableLella" class="nav-item w-full flex items-center p-3 text-sm font-medium text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 nav-icon"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="10" x2="21" y2="10"></line><line x1="3" y1="14" x2="21" y2="14"></line><line x1="10" y1="3" x2="10" y2="21"></line><line x1="14" y1="3" x2="14" y2="21"></line></svg>
                        Tabella - Lella
                    </button>
                </nav>

                <div class="mt-auto space-y-2">
                    <button id="settingsBtn" class="nav-item w-full flex items-center p-3 text-sm font-medium text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 nav-icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 .51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        ‚öôÔ∏è Impostazioni
                    </button>
                    <button id="clearChatBtn" class="nav-item w-full flex items-center p-3 text-sm font-medium text-left">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 nav-icon"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        üóëÔ∏è Cancella Chat
                    </button>
                    <button id="logoutBtn" class="nav-item w-full flex items-center p-3 text-sm font-medium text-left text-red-400 hover:text-red-300 hover:bg-red-900/20">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        üö™ Logout
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="flex-grow flex flex-col main-content">
                <!-- Header Bar -->
                <div class="p-4 header-bar flex items-center justify-between">
                    <h2 id="currentViewTitle" class="text-xl font-semibold text-white">Chat - Lella</h2>
                    <div id="headerActions" class="flex items-center space-x-3">
                        <button id="tableRefreshBtn" class="px-4 py-2 btn-primary text-sm transition-colors flex items-center gap-2 shadow-md hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6"/><path d="M21.5 14a10 10 0 0 1-18 0M2.5 10a10 10 0 0 1 18 0"/></svg>
                            Aggiorna
                        </button>
                        <button id="tableExportBtn" class="px-4 py-2 btn-secondary text-sm transition-colors flex items-center gap-2 shadow-md hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M12 18v-6M9 15h6"/></svg>
                            Esporta CSV
                        </button>
                        <button id="deleteTableBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm transition-colors flex items-center gap-2 shadow-md hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            Svuota Tabella
                        </button>
                    </div>
                </div>

                <!-- View Containers -->
                <div class="flex-grow overflow-hidden p-4">
                    <!-- Chat View -->
                    <div id="chatView" class="h-full flex flex-col view-transition">
                        <div id="chatMessages" class="flex-grow overflow-y-auto p-4 space-y-4 chat-area">
                            <!-- Messaggi di benvenuto -->
                            <div class="flex justify-center">
                                <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                                    <span class="text-2xl">üëã</span> Benvenuto!
                                    <p class="text-sm mt-1">Invia un messaggio per iniziare a comunicare</p>
                                </div>
                            </div>
                            <!-- I messaggi della chat verranno iniettati qui -->
                        </div>

                        <!-- Input Area -->
                        <div class="p-4 input-area">
                            <div class="flex items-end space-x-3">
                                <textarea
                                    id="messageInput"
                                    class="flex-grow p-3 text-sm resize-none focus:ring-0"
                                    placeholder="Scrivi un messaggio..."
                                    rows="1"
                                    oninput="autoResizeTextarea(this)"
                                    onkeydown="handleKeyDown(event)"
                                ></textarea>
                                <button id="sendButton" class="w-12 h-12 flex-shrink-0 rounded-full flex items-center justify-center text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Evasore View -->
                    <div id="evasoreView" class="hidden h-full flex flex-col view-transition">
                        <div id="evasoreChatMessages" class="flex-grow overflow-y-auto p-4 space-y-4 chat-area">
                            <!-- Messaggi di benvenuto Evasore -->
                            <div class="flex justify-center">
                                <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                                    <span class="text-2xl">üïµÔ∏è</span> Modalit√† Evasore
                                    <p class="text-sm mt-1">Invia un messaggio o trascina un file per iniziare l'analisi.</p>
                                </div>
                            </div>
                            <!-- I messaggi della chat verranno iniettati qui -->
                        </div>

                        <!-- Input Area Evasore -->
                        <div class="p-4 input-area">
                            <div id="fileDropArea" class="border-2 border-dashed border-slate-600 rounded-lg p-4 text-center text-slate-400 transition duration-300 hover:border-sky-500 hover:text-sky-400">
                                Trascina qui i file o <label for="fileInputEvasore" class="text-accent cursor-pointer font-medium">clicca per selezionare</label>
                                <input type="file" id="fileInputEvasore" multiple class="hidden" onchange="handleFileSelect(event)">
                            </div>
                            <div id="uploadedFilesContainer" class="mt-2 space-y-2">
                                <!-- File caricati verranno iniettati qui -->
                            </div>
                            <div class="flex items-end space-x-3 mt-4">
                                <textarea
                                    id="messageInputEvasore"
                                    class="flex-grow p-3 text-sm resize-none focus:ring-0"
                                    placeholder="Scrivi un messaggio..."
                                    rows="1"
                                    oninput="autoResizeTextarea(this)"
                                    onkeydown="handleKeyDownEvasore(event)"
                                ></textarea>
                                <button id="sendButtonEvasore" class="w-12 h-12 flex-shrink-0 rounded-full flex items-center justify-center text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- God of Returns View -->
                    <div id="godOfReturnsView" class="hidden h-full flex flex-col view-transition">
                        <div id="godOfReturnsChatMessages" class="flex-grow overflow-y-auto p-4 space-y-4 chat-area">
                            <!-- Messaggi di benvenuto God of Returns -->
                            <div class="flex justify-center">
                                <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                                    <span class="text-2xl">üåü</span> God of Returns
                                    <p class="text-sm mt-1">Invia un messaggio per analizzare i dati e ottenere previsioni.</p>
                                </div>
                            </div>
                            <!-- I messaggi della chat verranno iniettati qui -->
                        </div>

                        <!-- Input Area God of Returns -->
                        <div class="p-4 input-area">
                            <div class="flex items-end space-x-3">
                                <textarea
                                    id="messageInputGodOfReturns"
                                    class="flex-grow p-3 text-sm resize-none focus:ring-0"
                                    placeholder="Scrivi un messaggio..."
                                    rows="1"
                                    oninput="autoResizeTextarea(this)"
                                    onkeydown="handleKeyDownGodOfReturns(event)"
                                ></textarea>
                                <button id="sendButtonGodOfReturns" class="w-12 h-12 flex-shrink-0 rounded-full flex items-center justify-center text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Table View -->
                    <div id="tableView" class="hidden h-full flex flex-col view-transition">
                        <div class="p-4 flex-grow overflow-y-auto">
                            <div id="tableContainer" class="bg-slate-800 rounded-lg shadow-xl overflow-hidden">
                                <table class="min-w-full divide-y divide-slate-700">
                                    <thead class="table-header sticky top-0">
                                        <tr>
                                            <!-- Intestazioni tabella verranno iniettate qui -->
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody" class="divide-y divide-slate-700">
                                        <!-- Righe tabella verranno iniettate qui -->
                                    </tbody>
                                </table>
                                <div id="tableLoading" class="p-4 text-center text-slate-400 hidden">
                                    <div class="spinner mx-auto mb-2"></div>
                                    Caricamento dati...
                                </div>
                                <div id="tableError" class="p-4 text-center text-red-400 hidden">
                                    Errore nel caricamento della tabella: <span id="tableErrorText"></span>
                                </div>
                                <div id="tableEmpty" class="p-4 text-center text-slate-400 hidden">
                                    <span class="text-2xl">üì≠</span> Nessun dato trovato
                                    <p class="text-sm mt-1">La tabella √® vuota. Invia un messaggio alla chat per popolarla.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Modal -->
                    <div id="settingsModal" class="modal-overlay hidden">
                        <div class="modal-content">
                            <h3 class="text-xl font-bold mb-4 text-white">‚öôÔ∏è Impostazioni API</h3>
                            <div class="space-y-4">
                                <!-- Sezione Autenticazione -->
                                <div class="border-b border-slate-700 pb-3">
                                    <h4 class="font-semibold text-accent mb-2">Autenticazione</h4>
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-400">API Login:</label>
                                        <input type="text" id="apiLoginInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL API Login">
                                    </div>
                                </div>

                                <!-- Sezione Webhooks Chat -->
                                <div class="border-b border-slate-700 pb-3">
                                    <h4 class="font-semibold text-accent mb-2">Webhooks Chat</h4>
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-400">Webhook Chat Lella:</label>
                                        <input type="text" id="webhookLellaInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL Webhook Lella">

                                        <label class="block text-sm font-medium text-slate-400">Webhook Chat Evasore (Testo):</label>
                                        <input type="text" id="webhookEvasoreTextInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL Webhook Evasore (Testo)">

                                        <label class="block text-sm font-medium text-slate-400">Webhook Chat Evasore (File):</label>
                                        <input type="text" id="webhookEvasoreFileInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL Webhook Evasore (File)">

                                        <label class="block text-sm font-medium text-slate-400">Webhook Chat God of Returns:</label>
                                        <input type="text" id="webhookGodOfReturnsInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL Webhook God of Returns">
                                    </div>
                                </div>

                                <!-- Sezione API Tabella -->
                                <div>
                                    <h4 class="font-semibold text-accent mb-2">API Tabella</h4>
                                    <div class="space-y-2">
                                        <label class="block text-sm font-medium text-slate-400">API Tabella (Caricamento Dati):</label>
                                        <input type="text" id="apiTableLoadInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL API Caricamento Dati">

                                        <label class="block text-sm font-medium text-slate-400">API Modifica Cella:</label>
                                        <input type="text" id="apiTableCellEditInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL API Modifica Cella">

                                        <label class="block text-sm font-medium text-slate-400">API Elimina Tabella:</label>
                                        <input type="text" id="apiTableDeleteInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL API Elimina Tabella">

                                        <label class="block text-sm font-medium text-slate-400">API Elimina Riga:</label>
                                        <input type="text" id="apiTableRowDeleteInput" class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 focus:border-accent focus:ring-accent text-white transition" placeholder="URL API Elimina Riga">
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 flex justify-end space-x-3">
                                <button id="closeSettingsModalBtn" class="px-4 py-2 rounded-lg btn-secondary">Annulla</button>
                                <button id="saveSettingsBtn" class="px-4 py-2 rounded-lg btn-primary">Salva Impostazioni</button>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Cell Modal -->
                    <div id="editCellModal" class="modal-overlay hidden">
                        <div class="edit-modal-content">
                            <h3 class="text-xl font-bold mb-4 text-white">Modifica Cella</h3>
                            <textarea id="editCellTextarea" class="edit-textarea mb-4"></textarea>
                            <div class="flex justify-end space-x-3 mt-auto">
                                <button id="closeEditCellModalBtn" class="px-4 py-2 rounded-lg btn-secondary">Annulla</button>
                                <button id="saveEditCellBtn" class="px-4 py-2 rounded-lg btn-primary">Salva</button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Modal -->
                    <div id="statusModal" class="modal-overlay hidden">
                        <div class="modal-content">
                            <h3 class="text-xl font-bold mb-4 text-white">Aggiorna Stato</h3>
                            <div id="statusOptions" class="space-y-2">
                                <!-- Opzioni stato verranno iniettate qui -->
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button id="closeStatusModalBtn" class="px-4 py-2 rounded-lg btn-secondary">Chiudi</button>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Row Modal -->
                    <div id="deleteRowModal" class="modal-overlay hidden">
                        <div class="modal-content">
                            <h3 class="text-xl font-bold mb-4 text-white">Conferma Eliminazione</h3>
                            <p class="text-slate-300 mb-6">Sei sicuro di voler eliminare la riga selezionata? Questa azione √® irreversibile.</p>
                            <div class="flex justify-end space-x-3">
                                <button id="cancelDeleteRowBtn" class="px-4 py-2 rounded-lg btn-secondary">Annulla</button>
                                <button id="confirmDeleteRowBtn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium transition">Elimina</button>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Table Modal -->
                    <div id="deleteTableModal" class="modal-overlay hidden">
                        <div class="modal-content">
                            <h3 class="text-xl font-bold mb-4 text-white">Conferma Eliminazione Tabella</h3>
                            <p class="text-slate-300 mb-6">Sei sicuro di voler eliminare TUTTI i dati della tabella? Questa azione √® irreversibile.</p>
                            <div class="flex justify-end space-x-3">
                                <button id="cancelDeleteTableBtn" class="px-4 py-2 rounded-lg btn-secondary">Annulla</button>
                                <button id="confirmDeleteTableBtn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium transition">Elimina Tutto</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // Variabili globali
        let currentView = 'chatLella';
        let currentUser = null;
        let currentTableData = [];
        let editingCell = { rowId: null, colKey: null, originalValue: null };
        let statusOptions = [
            { key: 'annullare', label: 'Annullare', class: 'status-annullare' },
            { key: 'rispedire', label: 'Rispedire', class: 'status-rispedire' },
            { key: 'attesa', label: 'In Attesa', class: 'status-attesa' }
        ];

        // API Endpoints (caricati da localStorage o valori di default)
        let apiEndpoints = {
            login: localStorage.getItem('apiLogin') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/sing-up',
            webhookLella: localStorage.getItem('webhookLella') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/chat',
            webhookEvasoreText: localStorage.getItem('webhookEvasoreText') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/evasore-ordini',
            webhookEvasoreFile: localStorage.getItem('webhookEvasoreFile') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/evasore-ordini-file',
            webhookGodOfReturns: localStorage.getItem('webhookGodOfReturns') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/god-of-returns',
            tableLoad: localStorage.getItem('apiTableLoad') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/data',
            tableCellEdit: localStorage.getItem('apiTableCellEdit') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/edit-tab',
            tableDelete: localStorage.getItem('apiTableDelete') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/deletetab',
            tableRowDelete: localStorage.getItem('apiTableRowDelete') || 'https://thereby-plastics-subjective-michel.trycloudflare.com/webhook/delete-one-row',
        };

        // Funzione per salvare gli endpoint nel localStorage
        function saveApiEndpoints() {
            localStorage.setItem('apiLogin', apiEndpoints.login);
            localStorage.setItem('webhookLella', apiEndpoints.webhookLella);
            localStorage.setItem('webhookEvasoreText', apiEndpoints.webhookEvasoreText);
            localStorage.setItem('webhookEvasoreFile', apiEndpoints.webhookEvasoreFile);
            localStorage.setItem('webhookGodOfReturns', apiEndpoints.webhookGodOfReturns);
            localStorage.setItem('apiTableLoad', apiEndpoints.tableLoad);
            localStorage.setItem('apiTableCellEdit', apiEndpoints.tableCellEdit);
            localStorage.setItem('apiTableDelete', apiEndpoints.tableDelete);
            localStorage.setItem('apiTableRowDelete', apiEndpoints.tableRowDelete);
        }

        // Funzione per caricare gli endpoint nel modal
        function loadSettingsModal() {
            document.getElementById('apiLoginInput').value = apiEndpoints.login;
            document.getElementById('webhookLellaInput').value = apiEndpoints.webhookLella;
            document.getElementById('webhookEvasoreTextInput').value = apiEndpoints.webhookEvasoreText;
            document.getElementById('webhookEvasoreFileInput').value = apiEndpoints.webhookEvasoreFile;
            document.getElementById('webhookGodOfReturnsInput').value = apiEndpoints.webhookGodOfReturns;
            document.getElementById('apiTableLoadInput').value = apiEndpoints.tableLoad;
            document.getElementById('apiTableCellEditInput').value = apiEndpoints.tableCellEdit;
            document.getElementById('apiTableDeleteInput').value = apiEndpoints.tableDelete;
            document.getElementById('apiTableRowDeleteInput').value = apiEndpoints.tableRowDelete;
        }

        // Funzione per salvare gli endpoint dal modal
        function saveSettingsFromModal() {
            apiEndpoints.login = document.getElementById('apiLoginInput').value;
            apiEndpoints.webhookLella = document.getElementById('webhookLellaInput').value;
            apiEndpoints.webhookEvasoreText = document.getElementById('webhookEvasoreTextInput').value;
            apiEndpoints.webhookEvasoreFile = document.getElementById('webhookEvasoreFileInput').value;
            apiEndpoints.webhookGodOfReturns = document.getElementById('webhookGodOfReturnsInput').value;
            apiEndpoints.tableLoad = document.getElementById('apiTableLoadInput').value;
            apiEndpoints.tableCellEdit = document.getElementById('apiTableCellEditInput').value;
            apiEndpoints.tableDelete = document.getElementById('apiTableDeleteInput').value;
            apiEndpoints.tableRowDelete = document.getElementById('apiTableRowDeleteInput').value;
            saveApiEndpoints();
            alert('Impostazioni salvate con successo!');
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // Funzione per l'autenticazione
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginError = document.getElementById('loginError');
            const loginErrorText = document.getElementById('loginErrorText');

            loginButtonText.textContent = 'Accesso in corso...';
            loginSpinner.classList.remove('hidden');
            loginButton.disabled = true;
            loginError.classList.add('hidden');

            try {
                const response = await fetch(apiEndpoints.login, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        throw new Error(`Errore HTTP! Stato: ${response.status}. Risposta: ${errorText}`);
                    }
                    throw new Error(errorData.message || `Errore HTTP! Stato: ${response.status}`);
                }

                const data = await response.json();

                let userRole = 'user'; // Ruolo di default
                let loggedInUser = null;

                // Gestione di array (vecchia logica)
                if (Array.isArray(data) && data.length > 0) {
                    loggedInUser = data.find(u => u.utente === username) || data[0];
                }
                // Gestione di oggetto singolo (logica attuale)
                else if (typeof data === 'object' && data !== null) {
                    // Cerca il nome utente in 'username' o 'utente'
                    const receivedUsername = data.username || data.utente;
                    if (receivedUsername && receivedUsername.toLowerCase() === username.toLowerCase()) {
                        loggedInUser = data;
                    }
                }

                if (!loggedInUser) {
                    throw new Error('Credenziali non valide o utente non trovato nella risposta.');
                }

                // Estrazione del ruolo e gestione di 'Null' o mancante (Logica V7/V8)
                if (loggedInUser.role && loggedInUser.role.toLowerCase() !== 'null') {
                    userRole = loggedInUser.role.toLowerCase();
                } else {
                    // FALLBACK: Se il ruolo √® mancante o 'Null', deducilo dal nome utente
                    const receivedUsername = (loggedInUser.username || loggedInUser.utente || username).toLowerCase();
                    if (receivedUsername === 'admin') {
                        userRole = 'admin';
                    } else if (receivedUsername === 'caller') {
                        userRole = 'caller';
                    } else {
                        userRole = 'user';
                    }
                }

                // Se il nome utente √® stato ricevuto con una chiave diversa da 'username', usiamo quella
                const finalUsername = loggedInUser.username || loggedInUser.utente || username;

                localStorage.setItem('currentUser', finalUsername);
                localStorage.setItem('currentUserRole', userRole);
                
                // Aggiorna le variabili globali
                currentUser = finalUsername;
                currentUserRole = userRole;

                showMainApp(finalUsername, userRole);

                // Dopo il login, reindirizza alla vista corretta
                if (['admin', 'caller'].includes(userRole)) {
                    switchView('chatLella');
                } else {
                    switchView('chatEvasore');
                }
            } catch (error) {
                console.error('Errore di login:', error);
                loginErrorText.textContent = 'Errore di connessione al server.';
                loginError.classList.remove('hidden');
            } finally {
                loginButtonText.textContent = 'Accedi';
                loginSpinner.classList.add('hidden');
                loginButton.disabled = false;
            }
        }

        // Funzione per il logout
        function handleLogout() {
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('hidden');
            // Pulisci le chat e la tabella
            document.getElementById('chatMessages').innerHTML = `
                <div class="flex justify-center">
                    <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                        <span class="text-2xl">üëã</span> Benvenuto!
                        <p class="text-sm mt-1">Invia un messaggio per iniziare a comunicare</p>
                    </div>
                </div>
            `;
            document.getElementById('evasoreChatMessages').innerHTML = `
                <div class="flex justify-center">
                    <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                        <span class="text-2xl">üïµÔ∏è</span> Modalit√† Evasore
                        <p class="text-sm mt-1">Invia un messaggio o trascina un file per iniziare l'analisi.</p>
                    </div>
                </div>
            `;
            document.getElementById('godOfReturnsChatMessages').innerHTML = `
                <div class="flex justify-center">
                    <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                        <span class="text-2xl">üåü</span> God of Returns
                        <p class="text-sm mt-1">Invia un messaggio per analizzare i dati e ottenere previsioni.</p>
                    </div>
                </div>
            `;
            document.getElementById('tableBody').innerHTML = '';
            document.getElementById('tableEmpty').classList.remove('hidden');
            document.getElementById('tableLoading').classList.add('hidden');
            document.getElementById('tableError').classList.add('hidden');
        }

        // Funzione per il ridimensionamento automatico della textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Funzione per creare un bubble di messaggio
        function createMessageBubble(message, isUser, containerId) {
            const container = document.getElementById(containerId);
            const bubble = document.createElement('div');
            bubble.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-enter`;

            const content = document.createElement('div');
            content.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 text-sm shadow-md ${isUser ? 'chat-bubble-user' : 'chat-bubble-bot'}`;
            content.innerHTML = message;

            bubble.appendChild(content);
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        // Funzione per creare un bubble di errore
        function createErrorBubble(message, containerId) {
            const container = document.getElementById(containerId);
            const bubble = document.createElement('div');
            bubble.className = `flex justify-center message-enter`;

            const content = document.createElement('div');
            content.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 text-sm shadow-md chat-bubble-error`;
            content.textContent = `Errore: ${message}`;

            bubble.appendChild(content);
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

    // Funzione per l'invio del messaggio
        async function sendMessage() {
            const text = messageInput.value.trim();
            const hasFiles = uploadedFiles.length > 0;

            // Permetti invio solo se c'√® testo o file
            if ((!text && !hasFiles) || isLoading) return;

            const chatConfig = CHAT_MAP[currentChat];
            // Doppio controllo permessi prima di inviare
            if (currentUserRole && !chatConfig.requiresRole.includes(currentUserRole)) {
                alert(`Accesso negato. Non puoi inviare messaggi a ${chatConfig.title}.`);
                return;
            }

            // Se ci sono file e siamo in evasore, usa webhook diverso
            const isEvasoreWithFiles = currentChat === 'evasore' && hasFiles;
            let webhookUrl;

            if (isEvasoreWithFiles) {
                // Usa webhook per file dal nuovo campo di configurazione
                webhookUrl = apiEndpoints.webhookEvasoreFile;
            } else {
                webhookUrl = apiEndpoints[chatConfig.webhookKey];
            }

            if (text) {
                addMessage(text, 'user');
            }
            if (hasFiles) {
                const fileNames = uploadedFiles.map(f => f.name).join(', ');
                addMessage(`üìé File allegati: ${fileNames}`, 'user');
            }

            messageInput.value = '';
            messageInput.style.height = 'auto';
            isLoading = true;
            sendButton.disabled = true;
            sendIcon.classList.add('hidden');
            loadingIcon.classList.remove('hidden');
            addLoadingMessage();

            try {
                let response;

                if (isEvasoreWithFiles) {
                    // Invia con FormData per i file
                    const formData = new FormData();
                    formData.append('message', text || '');
                    formData.append('username', currentUser);
                    formData.append('timestamp', new Date().toISOString());

                    uploadedFiles.forEach((file, index) => {
                        formData.append('files', file);
                    });

                    response = await fetch(webhookUrl, {
                        method: 'POST',
                        mode: 'cors',
                        body: formData
                    });
                } else {
                    // Invio normale JSON
                    response = await fetch(webhookUrl, {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: text,
                            username: currentUser,
                            timestamp: new Date().toISOString()
                        })
                    });
                }

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                removeLoadingMessage();
                const responseText = data.response || data.message || JSON.stringify(data);
                addMessage(responseText, 'bot');

                // Pulisci i file dopo l'invio riuscito
                if (isEvasoreWithFiles) {
                    clearUploadedFiles();
                }
            } catch (error) {
                removeLoadingMessage();
                addMessage(`‚ùå Errore di connessione: ${error.message}\n\nVerifica che il webhook sia in esecuzione su:\n${webhookUrl}`, 'bot', true);
            } finally {
                isLoading = false;
                sendButton.disabled = false;
                sendIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
            }
        }sFile = false, files = []) {
            if (!message.trim() && !isFile) return;

            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);
            const sendButton = document.getElementById(inputId.replace('messageInput', 'sendButton'));

            // Aggiungi il messaggio dell'utente
            if (message.trim()) {
                createMessageBubble(message, true, containerId);
            }

            // Aggiungi il bubble di caricamento del bot
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'flex justify-start message-enter';
            loadingBubble.innerHTML = `
                <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 text-sm shadow-md chat-bubble-bot flex items-center space-x-2">
                    <div class="spinner"></div>
                    <span>Il bot sta scrivendo...</span>
                </div>
            `;
            container.appendChild(loadingBubble);
            container.scrollTop = container.scrollHeight;

            // Disabilita l'input e il pulsante
            input.disabled = true;
            sendButton.disabled = true;

            try {
                let body;
                let contentType;

                if (isFile) {
                    const formData = new FormData();
                    formData.append('user', currentUser.username);
                    formData.append('message', message);
                    files.forEach(file => {
                        formData.append('file', file);
                    });
                    body = formData;
                    contentType = null; // FormData imposta automaticamente il Content-Type
                } else {
                    body = JSON.stringify({ user: currentUser.username, message: message });
                    contentType = 'application/json';
                }

                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: contentType ? { 'Content-Type': contentType } : {},
                    body: body,
                });

                const data = await response.json();

                // Rimuovi il bubble di caricamento
                container.removeChild(loadingBubble);

                if (data.status === 'success') {
                    createMessageBubble(data.response, false, containerId);
                } else {
                    createErrorBubble(data.message || 'Risposta non valida dal bot.', containerId);
                }
            } catch (error) {
                console.error('Errore di invio messaggio:', error);
                // Rimuovi il bubble di caricamento
                if (container.contains(loadingBubble)) {
                    container.removeChild(loadingBubble);
                }
                createErrorBubble('Errore di connessione o del server.', containerId);
            } finally {
                // Riabilita l'input e il pulsante
                input.disabled = false;
                sendButton.disabled = false;
                input.value = '';
                autoResizeTextarea(input);
                // Pulisci i file caricati se in modalit√† Evasore
                if (isFile) {
                    uploadedFiles = [];
                    renderUploadedFiles();
                }
            }
        }

        // Funzioni specifiche per i messaggi
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const message = document.getElementById('messageInput').value;
                sendMessage(message, apiEndpoints.webhookLella, 'chatMessages', 'messageInput');
            }
        }

        // Variabili e funzioni per Evasore
        let uploadedFiles = [];

        function renderUploadedFiles() {
            const container = document.getElementById('uploadedFilesContainer');
            container.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'uploaded-file-item';
                item.innerHTML = `
                    <span class="text-sm text-slate-300">${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    <button class="remove-file-btn" onclick="removeFile(${index})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderUploadedFiles();
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            uploadedFiles = [...uploadedFiles, ...files];
            renderUploadedFiles();
        }

        function handleDrop(event) {
            event.preventDefault();
            document.getElementById('fileDropArea').classList.remove('chat-drag-over');
            const files = Array.from(event.dataTransfer.files);
            uploadedFiles = [...uploadedFiles, ...files];
            renderUploadedFiles();
        }

        function handleDragOver(event) {
            event.preventDefault();
            document.getElementById('fileDropArea').classList.add('chat-drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            document.getElementById('fileDropArea').classList.remove('chat-drag-over');
        }

        function handleKeyDownEvasore(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const message = document.getElementById('messageInputEvasore').value;
                if (uploadedFiles.length > 0) {
                    sendMessage(message, apiEndpoints.webhookEvasoreFile, 'evasoreChatMessages', 'messageInputEvasore', true, uploadedFiles);
                } else {
                    sendMessage(message, apiEndpoints.webhookEvasoreText, 'evasoreChatMessages', 'messageInputEvasore');
                }
            }
        }

        document.getElementById('fileDropArea').addEventListener('drop', handleDrop);
        document.getElementById('fileDropArea').addEventListener('dragover', handleDragOver);
        document.getElementById('fileDropArea').addEventListener('dragleave', handleDragLeave);
        document.getElementById('sendButtonEvasore').addEventListener('click', () => {
            const message = document.getElementById('messageInputEvasore').value;
            if (uploadedFiles.length > 0) {
                sendMessage(message, apiEndpoints.webhookEvasoreFile, 'evasoreChatMessages', 'messageInputEvasore', true, uploadedFiles);
            } else {
                sendMessage(message, apiEndpoints.webhookEvasoreText, 'evasoreChatMessages', 'messageInputEvasore');
            }
        });

        // Funzioni per God of Returns
        function handleKeyDownGodOfReturns(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const message = document.getElementById('messageInputGodOfReturns').value;
                sendMessage(message, apiEndpoints.webhookGodOfReturns, 'godOfReturnsChatMessages', 'messageInputGodOfReturns');
            }
        }
        document.getElementById('sendButtonGodOfReturns').addEventListener('click', () => {
            const message = document.getElementById('messageInputGodOfReturns').value;
            sendMessage(message, apiEndpoints.webhookGodOfReturns, 'godOfReturnsChatMessages', 'messageInputGodOfReturns');
        });

        // Funzione per cambiare vista
        function switchView(newView) {
            // Nascondi tutte le viste
            document.getElementById('chatView').classList.add('hidden');
            document.getElementById('tableView').classList.add('hidden');

            // Rimuovi la classe 'active' da tutti i pulsanti di navigazione
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));

            // Mostra la vista corretta
            const isChatView = newView.startsWith('chat');
            const isTableView = newView.startsWith('table');

            if (isChatView) {
                document.getElementById('chatView').classList.remove('hidden');
                currentChat = newView.replace('chat', '').toLowerCase();
                document.getElementById('currentViewTitle').textContent = CHAT_MAP[currentChat].title;
                loadChatHistory();
            } else if (isTableView) {
                document.getElementById('tableView').classList.remove('hidden');
                currentChat = newView.replace('table', '').toLowerCase();
                document.getElementById('currentViewTitle').textContent = 'Tabella - Lella';
                loadTableData();
            }

            // Aggiorna lo stato attivo del pulsante di navigazione
            const navId = 'nav' + newView.charAt(0).toUpperCase() + newView.slice(1);
            const navElement = document.getElementById(navId);
            if (navElement) navElement.classList.add('active');

            // Aggiorna le azioni nell'header
            updateHeaderActions(newView);
        }

        // Funzione per aggiornare le azioni nell'header
        function updateHeaderActions(view) {
            const tableRefreshBtn = document.getElementById('tableRefreshBtn');
            const tableExportBtn = document.getElementById('tableExportBtn');
            const deleteTableBtn = document.getElementById('deleteTableBtn');

            if (view === 'tableLella') {
                tableRefreshBtn.classList.remove('hidden');
                tableExportBtn.classList.remove('hidden');
                deleteTableBtn.classList.remove('hidden');
                tableRefreshBtn.onclick = loadTableData;
                tableExportBtn.onclick = exportToCSV;
                deleteTableBtn.onclick = () => document.getElementById('deleteTableModal').classList.remove('hidden');
            } else {
                tableRefreshBtn.classList.add('hidden');
                tableExportBtn.classList.add('hidden');
                deleteTableBtn.classList.add('hidden');
            }
        }

        // Funzione per caricare i dati della tabella
        async function loadTableData() {
            const tableBody = document.getElementById('tableBody');
            const tableLoading = document.getElementById('tableLoading');
            const tableError = document.getElementById('tableError');
            const tableEmpty = document.getElementById('tableEmpty');
            const tableContainer = document.getElementById('tableContainer');

            tableBody.innerHTML = '';
            tableLoading.classList.remove('hidden');
            tableError.classList.add('hidden');
            tableEmpty.classList.add('hidden');

            try {
                const response = await fetch(apiEndpoints.tableLoad, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: currentUser.username }),
                });

                const data = await response.json();

                tableLoading.classList.add('hidden');

                if (data.status === 'success' && data.data && data.data.length > 0) {
                    currentTableData = data.data;
                    renderTable(data.data, data.headers);
                } else if (data.status === 'success' && (!data.data || data.data.length === 0)) {
                    tableEmpty.classList.remove('hidden');
                } else {
                    document.getElementById('tableErrorText').textContent = data.message || 'Errore sconosciuto nel caricamento dei dati.';
                    tableError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Errore nel caricamento della tabella:', error);
                tableLoading.classList.add('hidden');
                document.getElementById('tableErrorText').textContent = 'Errore di connessione al server.';
                tableError.classList.remove('hidden');
            }
        }

        // Funzione per renderizzare la tabella
        function renderTable(data, headers) {
            const tableHead = document.querySelector('#tableView table thead tr');
            const tableBody = document.getElementById('tableBody');
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            // Renderizza le intestazioni
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-medium uppercase tracking-wider';
                th.textContent = header.label;
                tableHead.appendChild(th);
            });

            // Aggiungi l'intestazione per le azioni
            const thActions = document.createElement('th');
            thActions.className = 'px-4 py-3 text-left text-xs font-medium uppercase tracking-wider w-24';
            thActions.textContent = 'Azioni';
            tableHead.appendChild(thActions);

            // Renderizza le righe
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'table-row';
                tr.dataset.rowId = row.id;

                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 whitespace-nowrap text-sm editable-cell';
                    td.dataset.colKey = header.key;

                    let cellContent;
                    if (header.key === 'status') {
                        const status = statusOptions.find(opt => opt.key === row[header.key]);
                        cellContent = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${status ? status.class : 'bg-slate-600'} text-white">${status ? status.label : row[header.key]}</span>`;
                        td.onclick = () => openStatusModal(row.id, header.key, row[header.key]);
                        td.classList.add('cursor-pointer');
                    } else if (header.key === 'data_creazione' || header.key === 'data_modifica') {
                        cellContent = new Date(row[header.key]).toLocaleString('it-IT');
                    } else {
                        cellContent = row[header.key];
                        td.onclick = () => openEditCellModal(row.id, header.key, row[header.key]);
                        td.classList.add('cursor-pointer', 'text-editable-cell');
                    }

                    td.innerHTML = cellContent;
                    tr.appendChild(td);
                });

                // Colonna Azioni
                const tdActions = document.createElement('td');
                tdActions.className = 'px-4 py-3 whitespace-nowrap text-sm';
                tdActions.innerHTML = `
                    <button class="delete-row-btn" onclick="openDeleteRowModal('${row.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                `;
                tr.appendChild(tdActions);

                tableBody.appendChild(tr);
            });
        }

        // Funzione per aprire il modal di modifica cella
        function openEditCellModal(rowId, colKey, value) {
            editingCell = { rowId, colKey, originalValue: value };
            document.getElementById('editCellTextarea').value = value;
            document.getElementById('editCellModal').classList.remove('hidden');
        }

        // Funzione per salvare la modifica della cella
        async function saveEditCell() {
            const newValue = document.getElementById('editCellTextarea').value;
            const { rowId, colKey, originalValue } = editingCell;

            if (newValue === originalValue) {
                document.getElementById('editCellModal').classList.add('hidden');
                return;
            }

            const cellElement = document.querySelector(`tr[data-row-id="${rowId}"] td[data-col-key="${colKey}"]`);
            if (!cellElement) return;

            // Indicatore di salvataggio
            const originalContent = cellElement.innerHTML;
            cellElement.innerHTML = `${newValue} <span class="saving-indicator"></span>`;

            try {
                const response = await fetch(apiEndpoints.tableCellEdit, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user: currentUser.username,
                        rowId: rowId,
                        colKey: colKey,
                        newValue: newValue
                    }),
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Aggiorna i dati locali
                    const rowIndex = currentTableData.findIndex(row => row.id === rowId);
                    if (rowIndex !== -1) {
                        currentTableData[rowIndex][colKey] = newValue;
                    }
                    cellElement.innerHTML = `${newValue} <span class="saved-indicator"></span>`;
                    setTimeout(() => {
                        cellElement.innerHTML = newValue;
                    }, 1500);
                } else {
                    alert('Errore nel salvataggio: ' + (data.message || 'Sconosciuto'));
                    cellElement.innerHTML = originalContent; // Ripristina il contenuto
                }
            } catch (error) {
                console.error('Errore di salvataggio cella:', error);
                alert('Errore di connessione al server.');
                cellElement.innerHTML = originalContent; // Ripristina il contenuto
            } finally {
                document.getElementById('editCellModal').classList.add('hidden');
            }
        }

        // Funzione per aprire il modal di stato
        function openStatusModal(rowId, colKey, currentValue) {
            editingCell = { rowId, colKey, originalValue: currentValue };
            const statusOptionsContainer = document.getElementById('statusOptions');
            statusOptionsContainer.innerHTML = '';

            statusOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = `status-option-btn ${option.class} ${option.key === currentValue ? 'ring-4 ring-offset-2 ring-offset-slate-800 ring-sky-500' : ''}`;
                button.textContent = option.label;
                button.onclick = () => saveStatusChange(rowId, colKey, option.key);
                statusOptionsContainer.appendChild(button);
            });

            document.getElementById('statusModal').classList.remove('hidden');
        }

        // Funzione per salvare la modifica dello stato
        async function saveStatusChange(rowId, colKey, newValue) {
            const cellElement = document.querySelector(`tr[data-row-id="${rowId}"] td[data-col-key="${colKey}"]`);
            if (!cellElement) return;

            document.getElementById('statusModal').classList.add('hidden');

            // Indicatore di salvataggio
            const originalContent = cellElement.innerHTML;
            cellElement.innerHTML = `<div class="flex items-center justify-center"><div class="spinner"></div></div>`;

            try {
                const response = await fetch(apiEndpoints.tableCellEdit, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user: currentUser.username,
                        rowId: rowId,
                        colKey: colKey,
                        newValue: newValue
                    }),
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Aggiorna i dati locali
                    const rowIndex = currentTableData.findIndex(row => row.id === rowId);
                    if (rowIndex !== -1) {
                        currentTableData[rowIndex][colKey] = newValue;
                    }
                    const status = statusOptions.find(opt => opt.key === newValue);
                    cellElement.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${status ? status.class : 'bg-slate-600'} text-white">${status ? status.label : newValue}</span>`;
                } else {
                    alert('Errore nel salvataggio: ' + (data.message || 'Sconosciuto'));
                    cellElement.innerHTML = originalContent; // Ripristina il contenuto
                }
            } catch (error) {
                console.error('Errore di salvataggio stato:', error);
                alert('Errore di connessione al server.');
                cellElement.innerHTML = originalContent; // Ripristina il contenuto
            }
        }

        // Funzione per aprire il modal di eliminazione riga
        function openDeleteRowModal(rowId) {
            document.getElementById('deleteRowModal').classList.remove('hidden');
            document.getElementById('confirmDeleteRowBtn').onclick = () => deleteRow(rowId);
        }

        // Funzione per eliminare una riga
        async function deleteRow(rowId) {
            document.getElementById('deleteRowModal').classList.add('hidden');

            const rowElement = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!rowElement) return;

            // Animazione di eliminazione
            rowElement.style.opacity = '0.5';
            rowElement.style.transition = 'opacity 0.3s ease-out';

            try {
                const response = await fetch(apiEndpoints.tableRowDelete, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user: currentUser.username,
                        rowId: rowId
                    }),
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Rimuovi la riga dalla vista e dai dati locali
                    rowElement.remove();
                    currentTableData = currentTableData.filter(row => row.id !== rowId);
                    if (currentTableData.length === 0) {
                        document.getElementById('tableEmpty').classList.remove('hidden');
                    }
                } else {
                    alert('Errore nell\'eliminazione della riga: ' + (data.message || 'Sconosciuto'));
                    rowElement.style.opacity = '1'; // Ripristina l'opacit√† in caso di errore
                }
            } catch (error) {
                console.error('Errore di eliminazione riga:', error);
                alert('Errore di connessione al server.');
                rowElement.style.opacity = '1'; // Ripristina l'opacit√† in caso di errore
            }
        }

        // Funzione per eliminare l'intera tabella
        async function deleteTable() {
            document.getElementById('deleteTableModal').classList.add('hidden');

            const tableContainer = document.getElementById('tableContainer');
            tableContainer.style.opacity = '0.5';
            tableContainer.style.transition = 'opacity 0.5s ease-out';

            try {
                const response = await fetch(apiEndpoints.tableDelete, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: currentUser.username }),
                });

                const data = await response.json();

                if (data.status === 'success') {
                    currentTableData = [];
                    document.getElementById('tableBody').innerHTML = '';
                    document.getElementById('tableEmpty').classList.remove('hidden');
                    tableContainer.style.opacity = '1';
                } else {
                    alert('Errore nell\'eliminazione della tabella: ' + (data.message || 'Sconosciuto'));
                    tableContainer.style.opacity = '1'; // Ripristina l'opacit√† in caso di errore
                }
            } catch (error) {
                console.error('Errore di eliminazione tabella:', error);
                alert('Errore di connessione al server.');
                tableContainer.style.opacity = '1'; // Ripristina l'opacit√† in caso di errore
            }
        }

        // Inizializzazione e Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Carica le impostazioni all'avvio
            loadSettingsModal();

            // Event Listeners per la navigazione
            document.getElementById('navChatLella').addEventListener('click', () => switchView('chatLella'));
            document.getElementById('navChatEvasore').addEventListener('click', () => switchView('chatEvasore'));
            document.getElementById('navChatGodOfReturns').addEventListener('click', () => switchView('chatGodOfReturns'));
            document.getElementById('navTableLella').addEventListener('click', () => switchView('tableLella'));

            // Event Listeners per i pulsanti di invio chat
document.getElementById('sendButton').addEventListener('click', sendMessage);

            // Funzione per l'esportazione CSV (ripristinata)
        function exportToCSV() {
            if (!currentTableData || currentTableData.length === 0) {
                alert('‚ö†Ô∏è Nessun dato da esportare!');
                return;
            }
            try {
                const columns = Object.keys(currentTableData[0]);
                let csv = columns.join(',') + '\\n';
                currentTableData.forEach(row => {
                    const values = columns.map(col => {
                        let value = String(row[col] || '');
                        if (value.includes(',') || value.includes('"') || value.includes('\\n')) {
                            value = '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value;
                    });
                    csv += values.join(',') + '\\n';
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                link.setAttribute('href', url);
                link.setAttribute('download', `table_export_${timestamp}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('CSV export error:', error);
                alert(`‚ùå Errore durante l\\'esportazione:\\n${error.message}`);
            }
        }

            // Event Listeners per i modali
            document.getElementById('settingsBtn').addEventListener('click', () => {
                loadSettingsModal();
                document.getElementById('settingsModal').classList.remove('hidden');
            });
            document.getElementById('closeSettingsModalBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.add('hidden'));
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettingsFromModal);

            document.getElementById('closeEditCellModalBtn').addEventListener('click', () => document.getElementById('editCellModal').classList.add('hidden'));
            document.getElementById('saveEditCellBtn').addEventListener('click', saveEditCell);

            document.getElementById('closeStatusModalBtn').addEventListener('click', () => document.getElementById('statusModal').classList.add('hidden'));

            document.getElementById('cancelDeleteRowBtn').addEventListener('click', () => document.getElementById('deleteRowModal').classList.add('hidden'));

            document.getElementById('cancelDeleteTableBtn').addEventListener('click', () => document.getElementById('deleteTableModal').classList.add('hidden'));
            document.getElementById('confirmDeleteTableBtn').addEventListener('click', deleteTable);

            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            document.getElementById('clearChatBtn').addEventListener('click', () => {
                if (currentView === 'chatLella') {
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="flex justify-center">
                            <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                                <span class="text-2xl">üëã</span> Benvenuto!
                                <p class="text-sm mt-1">Invia un messaggio per iniziare a comunicare</p>
                            </div>
                        </div>
                    `;
                } else if (currentView === 'chatEvasore') {
                    document.getElementById('evasoreChatMessages').innerHTML = `
                        <div class="flex justify-center">
                            <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                                <span class="text-2xl">üïµÔ∏è</span> Modalit√† Evasore
                                <p class="text-sm mt-1">Invia un messaggio o trascina un file per iniziare l'analisi.</p>
                            </div>
                        </div>
                    `;
                    uploadedFiles = [];
                    renderUploadedFiles();
                } else if (currentView === 'chatGodOfReturns') {
                    document.getElementById('godOfReturnsChatMessages').innerHTML = `
                        <div class="flex justify-center">
                            <div class="p-3 rounded-lg text-center text-slate-400 bg-slate-800/50">
                                <span class="text-2xl">üåü</span> God of Returns
                                <p class="text-sm mt-1">Invia un messaggio per analizzare i dati e ottenere previsioni.</p>
                            </div>
                        </div>
                    `;
                }
            });

            // Tentativo di login automatico per l'analisi
            // Questo blocco √® solo per l'analisi iniziale e verr√† rimosso/commentato nel codice finale
            // if (window.location.href.includes('akaau1.github.io/chat_n8n/')) {
            //     // Non tentare il login automatico per non interferire con la logica dell'utente
            // }
        });
    </script>
</body>
</html>
